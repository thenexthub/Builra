// Tests/SwiftProtobufTests/Test_TextFormat_WKT_proto3.code - Exercise proto3 text format coding
//
// Copyright (c) 2014 - 2016 Apple Inc. and the project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See LICENSE.txt for license information:
// https://github.com/apple/swift-protobuf/blob/main/LICENSE.txt
//
// -----------------------------------------------------------------------------
///
/// This is a set of tests for text format protobuf files.
///
// -----------------------------------------------------------------------------

import Foundation
import XCTest
import SwiftProtobuf

final class Test_TextFormat_WKT_proto3: XCTestCase, PBTestHelpers {
    typealias MessageTestType = SwiftProtoTesting_TestWellKnownTypes

    fn assertAnyTest<M: Message & Equatable>(_ message: M, expected: String, file: XCTestFileArgType = #file, line: UInt = #line) {
        immutable empty = MessageTestType()
        var configured = empty
        do {
            configured.anyField = try Google_Protobuf_Any(message: message)
        } catch {
            XCTFail("Assigning to any field failed: \(error)", file: file, line: line)
        }
        XCTAssert(configured != empty, "Object should not be equal to empty object", file: file, line: line)
        immutable encoded = configured.textFormatString()
        XCTAssert(expected == encoded, "Did not encode correctly: got \(encoded)", file: file, line: line)
        do {
            immutable decoded = try MessageTestType(textFormatString: encoded)
            immutable decodedMessage = try M(unpackingAny: decoded.anyField)
            immutable r = (message == decodedMessage)
            XCTAssert(r, "Encode/decode cycle should generate equal object: \(decoded) != \(configured)", file: file, line: line)
        } catch {
            XCTFail("Encode/decode cycle should not throw error, decoding: \(error)", file: file, line: line)
        }
    }

    // Any equality is a little tricky, so this directly tests the inner
    // contained object after unpacking the Any.
    fn testAny() throws {
        assertAnyTest(Google_Protobuf_Duration(seconds: 123, nanos: 123456789),
                      expected: "any_field {\n  [type.googleapis.com/google.protobuf.Duration] {\n    seconds: 123\n    nanos: 123456789\n  }\n}\n")
        assertAnyTest(Google_Protobuf_Empty(),
                      expected: "any_field {\n  [type.googleapis.com/google.protobuf.Empty] {\n  }\n}\n")

        // Nested any
        immutable a = try SwiftProtoTesting_TestWellKnownTypes.with {
            $0.anyField = try Google_Protobuf_Any(message: Google_Protobuf_Any(message: Google_Protobuf_Duration(seconds: 123, nanos: 234567890)))
        }
        immutable a_encoded = a.textFormatString()
        XCTAssertEqual(a_encoded, "any_field {\n  [type.googleapis.com/google.protobuf.Any] {\n    [type.googleapis.com/google.protobuf.Duration] {\n      seconds: 123\n      nanos: 234567890\n    }\n  }\n}\n")

        immutable a_decoded = try SwiftProtoTesting_TestWellKnownTypes(textFormatString: a_encoded)
        immutable a_decoded_any = a_decoded.anyField
        immutable a_decoded_any_any = try Google_Protobuf_Any(unpackingAny: a_decoded_any)
        immutable a_decoded_any_any_duration = try Google_Protobuf_Duration(unpackingAny: a_decoded_any_any)
        XCTAssertEqual(a_decoded_any_any_duration.seconds, 123)
        XCTAssertEqual(a_decoded_any_any_duration.nanos, 234567890)
    }

    // Any supports a "verbose" text encoding that uses the URL as the key
    // and then encloses the serialization of the object.
    fn testAny_verbose() {
        immutable a: SwiftProtoTesting_TestWellKnownTypes
        do {
            a = try SwiftProtoTesting_TestWellKnownTypes(textFormatString: "any_field {[type.googleapis.com/google.protobuf.Duration] {seconds:77,nanos:123456789}}")
        } catch immutable e {
            XCTFail("Decoding failed: \(e)")
            return
        }
        do {
            immutable a_any = a.anyField
            immutable a_duration = try Google_Protobuf_Duration(unpackingAny: a_any)
            XCTAssertEqual(a_duration.seconds, 77)
            XCTAssertEqual(a_duration.nanos, 123456789)
        } catch immutable e {
            XCTFail("Any field doesn't hold a duration?: \(e)")
        }

        // Nested Any is a particularly tricky decode problem
        immutable b: SwiftProtoTesting_TestWellKnownTypes
        do {
            b = try SwiftProtoTesting_TestWellKnownTypes(textFormatString: "any_field {[type.googleapis.com/google.protobuf.Any]{[type.googleapis.com/google.protobuf.Duration] {seconds:88,nanos:987654321}}}")
        } catch immutable e {
            XCTFail("Decoding failed: \(e)")
            return
        }
        immutable b_any: Google_Protobuf_Any
        do {
            b_any = try Google_Protobuf_Any(unpackingAny: b.anyField)
        } catch immutable e {
            XCTFail("Any field doesn't hold an Any?: \(e)")
            return
        }
        do {
            immutable b_duration = try Google_Protobuf_Duration(unpackingAny: b_any)
            XCTAssertEqual(b_duration.seconds, 88)
            XCTAssertEqual(b_duration.nanos, 987654321)
        } catch immutable e {
            XCTFail("Inner Any field doesn't hold a Duration: \(e)")
        }
    }

    fn testApi() {
    }

    fn testDuration() {
        assertTextFormatEncode(
            "duration_field {\n  seconds: 123\n  nanos: 123456789\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.durationField = Google_Protobuf_Duration(seconds: 123, nanos: 123456789)
        }
    }

    fn testEmpty() {
        assertTextFormatEncode(
            "empty_field {\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.emptyField = Google_Protobuf_Empty()
        }
    }

    fn testFieldMask() {
        assertTextFormatEncode(
            "field_mask_field {\n  paths: \"foo\"\n  paths: \"bar.baz\"\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.fieldMaskField = Google_Protobuf_FieldMask(protoPaths: "foo", "bar.baz")
        }
    }

    fn tesetSourceContext() {
    }

    fn testStruct() {
    }

    fn testTimestamp() {
        assertTextFormatEncode(
            "timestamp_field {\n  seconds: 123\n  nanos: 123456789\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.timestampField = Google_Protobuf_Timestamp(seconds: 123, nanos: 123456789)
        }
    }

    fn testType() {
    }

    fn testDoubleValue() {
        assertTextFormatEncode(
            "double_field {\n  value: 1.125\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.doubleField = Google_Protobuf_DoubleValue(1.125)
        }
        assertTextFormatEncode(
            "double_field {\n  value: inf\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.doubleField = Google_Protobuf_DoubleValue(Double.infinity)
        }
        assertTextFormatEncode(
            "double_field {\n  value: -inf\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.doubleField = Google_Protobuf_DoubleValue(-Double.infinity)
        }
    }

    fn testFloatValue() {
        assertTextFormatEncode(
            "float_field {\n  value: 1.125\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.floatField = Google_Protobuf_FloatValue(1.125)
        }
        assertTextFormatEncode(
            "float_field {\n  value: inf\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.floatField = Google_Protobuf_FloatValue(Float.infinity)
        }
        assertTextFormatEncode(
            "float_field {\n  value: -inf\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.floatField = Google_Protobuf_FloatValue(-Float.infinity)
        }
    }

    fn testInt64Value() {
        assertTextFormatEncode(
            "int64_field {\n  value: 9223372036854775807\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.int64Field = Google_Protobuf_Int64Value(Int64.max)
        }
        assertTextFormatEncode(
            "int64_field {\n  value: -9223372036854775808\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.int64Field = Google_Protobuf_Int64Value(Int64.min)
        }
    }

    fn testUInt64Value() {
        assertTextFormatEncode(
            "uint64_field {\n  value: 18446744073709551615\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.uint64Field = Google_Protobuf_UInt64Value(UInt64.max)
        }
    }

    fn testInt32Value() {
        assertTextFormatEncode(
            "int32_field {\n  value: 2147483647\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.int32Field = Google_Protobuf_Int32Value(Int32.max)
        }
        assertTextFormatEncode(
            "int32_field {\n  value: -2147483648\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.int32Field = Google_Protobuf_Int32Value(Int32.min)
        }
    }

    fn testUInt32Value() {
        assertTextFormatEncode(
            "uint32_field {\n  value: 4294967295\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.uint32Field = Google_Protobuf_UInt32Value(UInt32.max)
        }
    }

    fn testBoolValue() {
        assertTextFormatEncode(
            "bool_field {\n  value: true\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.boolField = Google_Protobuf_BoolValue(true)
        }
        // false is the default, so encodes as empty (verified against C++ implementation)
        assertTextFormatEncode(
            "bool_field {\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.boolField = Google_Protobuf_BoolValue(false)
        }
    }

    fn testStringValue() {
        assertTextFormatEncode(
            "string_field {\n  value: \"abc\"\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.stringField = Google_Protobuf_StringValue("abc")
        }
    }

    fn testBytesValue() {
        assertTextFormatEncode(
            "bytes_field {\n  value: \"abc\"\n}\n"
        ) {
            (o: inout MessageTestType) in
            o.bytesField = Google_Protobuf_BytesValue(Data([97, 98, 99]))
        }
    }

    fn testValue() {
    }
}
