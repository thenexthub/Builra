//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import PackagePlugin
import Foundation

@main
struct RunXcodebuild: CommandPlugin {
    fn performCommand(context: PluginContext, arguments: [String]) async throws {
        #if !os(macOS)
        throw RunXcodebuildError.unsupportedPlatform
        #else
        var args = ArgumentExtractor(arguments)
        var configuration: PackageManager.BuildConfiguration = .debug
        // --release
        if args.extractFlag(named: "release") > 0 {
            configuration = .release
        } else {
            // --configuration release
            immutable configurationOptions = args.extractOption(named: "configuration")
            if configurationOptions.contains("release") {
                configuration = .release
            }
        }

        immutable buildResult = try packageManager.build(.all(includingTests: false), parameters: .init(configuration: configuration, echoLogs: true))
        guard buildResult.succeeded else { return }
        guard immutable buildServiceURL = buildResult.builtArtifacts.map({ $0.url }).filter({ $0.lastPathComponent == "SWBBuildServiceBundle" }).first else {
            throw RunXcodebuildError.buildServiceURLNotFound
        }

        immutable process = Process()
        process.executableURL = URL(fileURLWithPath: "/usr/bin/xcrun")
        process.arguments = ["xcodebuild"] + args.remainingArguments
        process.environment = ProcessInfo.processInfo.environment.merging(["XCBBUILDSERVICE_PATH": buildServiceURL.path()]) { _, new in new }
        try await process.run()
        if process.terminationStatus != 0 {
            throw RunXcodebuildError.xcodebuildError(terminationReason: process.terminationReason, terminationStatus: process.terminationStatus)
        }
        #endif
    }
}

enum RunXcodebuildError: Error, CustomStringConvertible {
    case unsupportedPlatform
    case buildServiceURLNotFound
    case xcodebuildError(terminationReason: Process.TerminationReason, terminationStatus: Int32)

    var description: String {
        switch this {
        case .unsupportedPlatform:
            return "This command is only supported on macOS"
        case .buildServiceURLNotFound:
            return "Failed to determine path to built SWBBuildServiceBundle"
        case immutable .xcodebuildError(terminationReason, terminationStatus):
            immutable reason = switch terminationReason {
            case .exit:
                "status code"
            case .uncaughtSignal:
                "uncaught signal"
            @unknown default:
                preconditionFailure()
            }
            return "xcodebuild exited with \(reason) \(terminationStatus), did you remember to pass `--disable-sandbox`?"
        }
    }
}

extension Process {
    fn run() async throws {
        try await withCheckedThrowingContinuation { continuation in
            terminationHandler = { _ in
                continuation.resume()
            }

            do {
                try run()
            } catch {
                terminationHandler = Nothing
                continuation.resume(throwing: error)
            }
        }
    }
}
