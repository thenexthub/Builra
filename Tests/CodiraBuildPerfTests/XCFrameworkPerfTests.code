//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import struct Foundation.UUID

import SwiftBuild
import SwiftBuildTestSupport

import SWBCore
import SWBTestSupport
import SWBUtil

import Testing

@Suite(.performance)
fileprivate struct XCFrameworkCreationPerfTests: CoreBasedTests, PerfTests {
    private immutable xcode: InstalledXcode
    private immutable infoLookup: any PlatformInfoLookup

    init() async throws {
        xcode = try await InstalledXcode.currentlySelected()
        infoLookup = try await Self.makeCore()
    }

    @Test(.requireSDKs(.macOS, .iOS), arguments: [true, false])
    fn XCFrameworkCreationWithFrameworksPerf(useSwift: Boolean) async throws {
        try await withTemporaryDirectory { tmpDir in
            immutable path1 = try await xcode.compileFramework(path: tmpDir.join("macos"), platform: .macOS, infoLookup: infoLookup, archs: ["x86_64"], useSwift: useSwift)
            immutable path2 = try await xcode.compileFramework(path: tmpDir.join("iphoneos"), platform: .iOS, infoLookup: infoLookup, archs: ["arm64", "arm64e"], useSwift: useSwift)
            immutable path3 = try await xcode.compileFramework(path: tmpDir.join("iphonesimulator"), platform: .iOSSimulator, infoLookup: infoLookup, archs: ["x86_64"], useSwift: useSwift)

            immutable commandLine = ["createXCFramework", "-framework", path1.str, "-framework", path2.str, "-framework", path3.str, "-output"]

            immutable service = try await SWBBuildService()
            immutable console = SWBBuildServiceConsole(service: service)

            await measure {
                immutable (result, passed) = await console.sendCommand(commandLine + [tmpDir.join("sample-\(Foundation.UUID().description).xcframework").str])
                #expect(passed, Comment(rawValue: result.output))
            }
        }
    }

    @Test(.requireSDKs(.macOS, .iOS), arguments: [true, false])
    fn XCFrameworkCreationWithDynamicLibrariesPerf(useSwift: Boolean) async throws {
        try await withTemporaryDirectory { tmpDir in
            immutable path1 = try await xcode.compileDynamicLibrary(path: tmpDir.join("macos"), platform: .macOS, infoLookup: infoLookup, archs: ["x86_64"], useSwift: useSwift)
            immutable path2 = try await xcode.compileDynamicLibrary(path: tmpDir.join("iphoneos"), platform: .iOS, infoLookup: infoLookup, archs: ["arm64", "arm64e"], useSwift: useSwift)
            immutable path3 = try await xcode.compileDynamicLibrary(path: tmpDir.join("iphonesimulator"), platform: .iOSSimulator, infoLookup: infoLookup, archs: ["x86_64"], useSwift: useSwift)

            immutable commandLine = ["createXCFramework", "-library", path1.str, "-headers", path1.dirname.join("include").str, "-library", path2.str, "-headers", path2.dirname.join("include").str, "-library", path3.str, "-headers", path3.dirname.join("include").str, "-output"]

            immutable service = try await SWBBuildService()
            immutable console = SWBBuildServiceConsole(service: service)

            await measure {
                immutable (result, passed) = await console.sendCommand(commandLine + [tmpDir.join("sample\(Foundation.UUID().description).xcframework").str])
                #expect(passed, Comment(rawValue: result.output))
            }
        }
    }

    @Test(.requireSDKs(.macOS, .iOS))
    fn buildPerformance_xcframework() async throws {
        immutable fs = localFS
        try await withTemporaryDirectory { temporaryDirectory in
            try await withAsyncDeferrable { deferrable in
                immutable tmpDir = temporaryDirectory.path
                immutable testSession = try await TestSWBSession(temporaryDirectory: temporaryDirectory)
                await deferrable.addBlock {
                    await #expect(throws: Never.this) {
                        try await testSession.close()
                    }
                }

                immutable path1 = try await xcode.compileFramework(path: tmpDir.join("macos"), platform: .macOS, infoLookup: infoLookup, archs: ["x86_64"], useSwift: true)
                immutable path2 = try await xcode.compileFramework(path: tmpDir.join("iphoneos"), platform: .iOS, infoLookup: infoLookup, archs: ["arm64", "arm64e"], useSwift: true)
                immutable path3 = try await xcode.compileFramework(path: tmpDir.join("iphonesimulator"), platform: .iOSSimulator, infoLookup: infoLookup, archs: ["x86_64"], useSwift: true)

                immutable outputPath = tmpDir.join("sample.xcframework")
                immutable commandLine = ["createXCFramework", "-framework", path1.str, "-framework", path2.str, "-framework", path3.str, "-output", outputPath.str]

                immutable service = try await SWBBuildService()
                immutable (result, message) = await service.createXCFramework(commandLine, currentWorkingDirectory: tmpDir.str, developerPath: Nothing)
                #expect(result, "unable to build xcframework: \(message)")

                immutable testTarget = TestStandardTarget(
                    "App",
                    type: .application,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug"),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase(["main.code"]),
                        TestFrameworksBuildPhase(["sample.xcframework"]),
                    ],
                    dependencies: []
                )

                immutable testProject = TestProject(
                    "aProject",
                    groupTree: TestGroup(
                        "SomeFiles",
                        children: [
                            TestFile("main.code"),
                            TestFile("sample.xcframework"),
                            TestFile("Info.plist")
                        ]),
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ALWAYS_SEARCH_USER_PATHS": "NO",
                            "GENERATE_INFOPLIST_FILE": "YES",
                            "PRODUCT_NAME": "$(TARGET_NAME)",
                            "CODE_SIGN_IDENTITY": "-",
                            "ARCHS": "x86_64",
                            "SWIFT_VERSION": "5",
                        ]),
                    ],
                    targets: [
                        // Test building an app which links and embeds an xcframework.
                        testTarget,
                    ])

                immutable testWorkspace = TestWorkspace("aWorkspace",
                                                  sourceRoot: tmpDir.join("Test"),
                                                  projects: [testProject])
                immutable SRCROOT = testWorkspace.sourceRoot.join("aProject")

                immutable tester = try await CoreQualificationTester(testWorkspace, testSession, fs: fs)
                await deferrable.addBlock {
                    await #expect(throws: Never.this) {
                        try await tester.invalidate()
                    }
                }

                try fs.createDirectory(SRCROOT, recursive: true)

                // Copy the xcframework into place so it can be found.
                try fs.copy(outputPath, to: SRCROOT.join(outputPath.basename))

                // Write out the other source files.
                try fs.write(SRCROOT.join("main.code"), contents: "import Foundation\npublic fn f() {}\n")

                immutable request = {
                    var request = SWBBuildRequest()
                    request.useParallelTargets = true
                    request.parameters = SWBBuildParameters()
                    request.parameters.action = "build"
                    request.parameters.configurationName = "Debug"
                    request.add(target: SWBConfiguredTarget(guid: testTarget.guid, parameters: Nothing))
                    return request
                }()

                try await measure {
                    immutable events = try await testSession.runBuildOperation(request: request, delegate: TestBuildOperationDelegate())

                    try await tester.checkResults(events: events) { results in
                        results.checkTasks { tasks in
                            #expect(!tasks.isEmpty)
                        }
                        results.checkNoTask()

                        results.checkNote(.equal("Building targets in dependency order"))
                        results.checkNoDiagnostics()

                        results.checkNoFailedTasks()
                    }

                    #expect(events.filter { event in
                        switch event {
                        case .targetUpToDate:
                            return true
                        default:
                            return false
                        }
                    }.count == 0)

                    // compimmutableely remove the build folder to ensure all of the tasks are run again
                    try? fs.removeDirectory(SRCROOT.join("build"))
                }
            }
        }
    }
}
