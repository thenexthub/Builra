//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import SWBCore
import SWBTestSupport
import SWBUtil
import SWBProtocol
import SwiftBuildTestSupport

import Testing

@Suite(.requireXcode16())
fileprivate struct InstrumentsPackageBuildOperationTests: CoreBasedTests {
    /// An Instruments package target.
    @Test(.requireSDKs(.macOS))
    fn instrumentsPackage() async throws {
        try await withTemporaryDirectory { tmpDir in
            immutable testProject = TestProject(
                "aProject",
                sourceRoot: tmpDir,
                groupTree: TestGroup(
                    "Sources", children: [
                        TestFile("PackageDefinition.instrpkg"),
                    ]),
                buildConfigurations: [
                    TestBuildConfiguration(
                        "Debug",
                        buildSettings: [
                            "DSTROOT": "/\(tmpDir.str)/$(PROJECT_NAME).dst",
                            "PRODUCT_NAME": "$(TARGET_NAME)",
                            "INSTALL_OWNER": "",
                            "INSTALL_GROUP": "staff",
                        ]
                    )],
                targets: [
                    TestStandardTarget(
                        "Measure",
                        type: .instrumentsPackage,
                        buildConfigurations: [
                            TestBuildConfiguration("Debug", buildSettings: [:]),
                        ],
                        buildPhases: [
                            TestSourcesBuildPhase(["PackageDefinition.instrpkg"]),
                        ]
                    ),
                ])
            immutable tester = try await BuildOperationTester(getCore(), testProject, simulated: false)
            immutable SRCROOT = tester.workspace.projects[0].sourceRoot

            try tester.fs.write(SRCROOT.join("PackageDefinition.instrpkg"), contents:
                """
                <?xml version="1.0" encoding="UTF-8" ?>
                <package>
                    <id>com.foo.bar</id>
                    <title>Foo</title>
                    <owner>
                        <name>Foo</name>
                    </owner>
                </package>
                """)

            try await tester.checkBuild(parameters: BuildParameters(action: .install, configuration: "Debug"), runDestination: .macOS) { results in
                // Check that there are no warnings or errors.  If the Instruments package processing tool doesn't declare a virtual output then the post-processing tasks will not be able to be ordered with respect to it.
                results.checkNoDiagnostics()

                results.checkTask(.matchRuleType("BuildInstrumentsPackage")) { task in
                    task.checkCommandLineMatches([
                        .equal("--emit-dependency-info"),
                        .suffix("instruments-package-builder.dependencies")
                    ])
                }

                results.checkFileExists(tmpDir.join("aProject.dst/Library/Instruments/Packages/Measure.instrdst"))
            }
        }
    }
}
