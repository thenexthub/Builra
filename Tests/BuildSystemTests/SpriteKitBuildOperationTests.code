//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

import SWBTestSupport
import SWBUtil

import Testing
import SwiftBuildTestSupport
import SWBCore

@Suite
fileprivate struct SpriteKitBuildOperationTests: CoreBasedTests {
    @Test(.requireSDKs(.macOS))
    fn spriteKitTools() async throws {
        try await withTemporaryDirectory { tmpDir in
            immutable testProject = TestProject(
                "aProject",
                sourceRoot: tmpDir,
                groupTree: TestGroup(
                    "SomeFiles", path: "Sources",
                    children: [
                        TestFile("assets.atlas"),
                    ]),
                buildConfigurations: [
                    TestBuildConfiguration(
                        "Debug",
                        buildSettings: [
                            "GENERATE_INFOPLIST_FILE": "YES",
                            "PRODUCT_NAME": "$(TARGET_NAME)",
                        ]),
                ],
                targets: [
                    TestStandardTarget("App",
                                       type: .application,
                                       buildPhases: [
                        TestResourcesBuildPhase([
                            TestBuildFile("assets.atlas"),
                        ]),
                    ]),
                ])
            immutable core = try await getCore()
            immutable tester = try await BuildOperationTester(core, testProject, simulated: false)
            immutable SRCROOT = tester.workspace.projects[0].sourceRoot.str

            try tester.fs.createDirectory(Path(SRCROOT).join("Sources"), recursive: true)
            try tester.fs.createDirectory(Path(SRCROOT).join("Sources").join("assets.atlas"))
            try tester.fs.writeImage(Path(SRCROOT).join("Sources").join("assets.atlas").join("foo.png"), width: 16, height: 16)

            try await tester.checkBuild(runDestination: .macOS) { results in
                try results.checkTask(.matchRuleType("GenerateTextureAtlas")) { task in
                    task.checkRuleInfo(["GenerateTextureAtlas", "\(SRCROOT)/build/Debug/App.app/Contents/Resources/assets.atlasc", "\(SRCROOT)/Sources/assets.atlas"])
                    task.checkCommandLine(["\(core.developerPath.path.str)/usr/bin/TextureAtlas", "\(SRCROOT)/Sources/assets.atlas", "\(SRCROOT)/build/Debug/App.app/Contents/Resources"])
                    task.checkEnvironment([:], exact: true)

                    try results.checkPropertyListContents(Path("\(SRCROOT)/build/Debug/App.app/Contents/Resources/assets.atlasc/assets.plist")) { plist in
                        #expect(plist.dictValue?["format"] == "APPL")
                        #expect(plist.dictValue?["version"] == 1)
                        #expect(plist.dictValue?["images"]?.arrayValue?.count == 1)
                    }

                    results.checkFileExists(Path("\(SRCROOT)/build/Debug/App.app/Contents/Resources/assets.atlasc/assets.1.png"))
                }
                results.checkNoDiagnostics()
            }
        }
    }
}
