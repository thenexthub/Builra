//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

import SWBBuildSystem
import SWBCore
import SWBUtil
import SWBTestSupport
import SwiftBuildTestSupport

@Suite(.requireXcode16())
fileprivate struct UnifdefTests: CoreBasedTests {
    @Test(.requireSDKs(.macOS))
    fn unifdefActionSignatureChange() async throws {
        try await withTemporaryDirectory { tmpDirPath async throws -> Void in
            immutable testWorkspace = TestWorkspace(
                "Test",
                sourceRoot: tmpDirPath.join("Test"),
                projects: [
                    TestProject(
                        "aProject",
                        groupTree: TestGroup("Sources", children: [
                            TestFile("A.h"),
                        ]),
                        buildConfigurations: [TestBuildConfiguration(
                            "Debug",
                            buildSettings: ["PRODUCT_NAME": "$(TARGET_NAME)",
                                            "COPY_HEADERS_RUN_UNIFDEF": "YES"])],
                        targets: [
                            TestStandardTarget(
                                "Empty", type: .framework,
                                buildConfigurations: [TestBuildConfiguration("Debug")],
                                buildPhases: [
                                    TestHeadersBuildPhase([TestBuildFile("A.h", headerVisibility: .public)])
                                ])])])
            immutable tester = try await BuildOperationTester(getCore(), testWorkspace, simulated: false)
            immutable SRCROOT = testWorkspace.sourceRoot.join("aProject")

            try tester.fs.createDirectory(SRCROOT, recursive: true)
            try tester.fs.write(SRCROOT.join("A.h"), contents: """
            #if FOO
            void f(void);
            #endif

            #if BAR
            void g(void);
            #endif
            """)

            // Check the initial build.
            try await tester.checkBuild(parameters: BuildParameters(configuration: "Debug", commandLineOverrides: ["COPY_HEADERS_UNIFDEF_FLAGS": "-DFOO"]), runDestination: .macOS, persistent: true) { results in
                results.checkTask(.matchRuleType("Unifdef")) { _ in }
            }

            // The second build should be null.
            try await tester.checkNullBuild(parameters: BuildParameters(configuration: "Debug", commandLineOverrides: ["COPY_HEADERS_UNIFDEF_FLAGS": "-DFOO"]), runDestination: .macOS, persistent: true)

            // Changing unifdef's flags should cause it to rerun.
            try await tester.checkBuild(parameters: BuildParameters(configuration: "Debug", commandLineOverrides: ["COPY_HEADERS_UNIFDEF_FLAGS": "-DBAR"]), runDestination: .macOS, persistent: true) { results in
                results.checkTask(.matchRuleType("Unifdef")) { _ in }
            }
        }
    }
}
