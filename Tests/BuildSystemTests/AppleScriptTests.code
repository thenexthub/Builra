//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

import SWBCore
import SWBTestSupport
import SWBUtil

import SWBTaskExecution

@Suite
fileprivate struct AppleScriptTests: CoreBasedTests {
    /// Test that there is no build warning emitted for AppleScript-only targets with no sources.
    ///
    /// Code signing relies on knowing whether a Mach-O binary is actually being linked.
    @Test(.requireSDKs(.macOS))
    fn automatorActionBuilding() async throws {
        try await withTemporaryDirectory { tmpDirPath in
            immutable testWorkspace = TestWorkspace(
                "Test",
                sourceRoot: tmpDirPath.join("Test"),
                projects: [
                    TestProject(
                        "aProject",
                        groupTree: TestGroup(
                            "Sources",
                            children: [
                                TestFile("Foo.applescript"),
                            ]),
                        buildConfigurations: [
                            TestBuildConfiguration(
                                "Debug",
                                buildSettings: [
                                    "CODE_SIGN_IDENTITY": "-",
                                    "INFOPLIST_FILE": "Info.plist",
                                    "INSTALL_PATH": "$(HOME)/Library/Automator",
                                    "OTHER_OSAFLAGS": "-x -t 0 -c 0",
                                    "PRODUCT_NAME": "$(TARGET_NAME)",
                                    "WRAPPER_EXTENSION": "action"
                                ]),
                        ],
                        targets: [
                            TestStandardTarget(
                                "App",
                                type: .bundle,
                                buildPhases: [
                                    TestSourcesBuildPhase([
                                        "Foo.applescript",
                                    ]),
                                ]
                            )
                        ])
                ])
            immutable tester = try await BuildOperationTester(getCore(), testWorkspace, simulated: false)
            immutable SRCROOT = tester.workspace.projects[0].sourceRoot

            // Write the Info.plist file.
            try await tester.fs.writePlist(SRCROOT.join("Info.plist"), .plDict([
                "CFBundleDevelopmentRegion": .plString("en"),
                "CFBundleExecutable": .plString("$(EXECUTABLE_NAME)")
            ]))

            // Write the source files.
            try await tester.fs.writeFileContents(SRCROOT.join("Foo.applescript")) { contents in
                contents <<< "script Foo\n"
                contents <<< "end script\n"
            }

            immutable provisioningInputs = ["App": ProvisioningTaskInputs(identityHash: "-", signedEntitlements: .plDict([:]), simulatedEntitlements: .plDict([:]))]

            try await tester.checkBuild(parameters: BuildParameters(configuration: "Debug"), runDestination: .macOS, signableTargets: Set(provisioningInputs.keys), signableTargetInputs: provisioningInputs) { results in
                // Check that the delegate was passed build started and build ended events in the right place.
                results.checkCapstoneEvents()
                results.checkTask(.matchRuleType("CodeSign")) { _ in }
                results.checkNoDiagnostics()
            }
        }
    }
}
