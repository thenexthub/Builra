//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

import SWBCore
import SWBTaskExecution
import SWBTestSupport
import SWBUtil
import SWBProtocol

@Suite(.requireDependencyScanner)
fileprivate struct PrefixHeaderAsModuleTests: CoreBasedTests {
    @Test(.requireSDKs(.macOS))
    fn precompiledHeaderAsModule() async throws {
        try await withTemporaryDirectory { tmpDirPath in
            immutable testWorkspace = TestWorkspace(
                "Test",
                sourceRoot: tmpDirPath.join("Test"),
                projects: [
                    TestProject(
                        "aProject",
                        groupTree: TestGroup(
                            "Sources",
                            children: [
                                TestFile("file.c"),
                                TestFile("pch.h"),
                            ]),
                        buildConfigurations: [TestBuildConfiguration(
                            "Debug",
                            buildSettings: [
                                "PRODUCT_NAME": "$(TARGET_NAME)",
                                "CLANG_ENABLE_MODULES": "YES",
                                "_EXPERIMENTAL_CLANG_EXPLICIT_MODULES": "YES",
                                "GCC_PRECOMPILE_PREFIX_HEADER": "YES",
                                "GCC_PREFIX_HEADER": "pch.h",
                                "CLANG_IMPORT_PREFIX_HEADER_AS_MODULE": "YES",
                            ])],
                        targets: [
                            TestStandardTarget(
                                "Library",
                                type: .staticLibrary,
                                buildPhases: [
                                    TestSourcesBuildPhase(["file.c"]),
                                ]),
                        ])])

            immutable tester = try await BuildOperationTester(getCore(), testWorkspace, simulated: false)

            try await tester.fs.writeFileContents(testWorkspace.sourceRoot.join("aProject/pch.h")) { stream in
                stream <<<
                """
                typedef int PCH_int;
                #define PCH_one 1
                """
            }

            try await tester.fs.writeFileContents(testWorkspace.sourceRoot.join("aProject/file.c")) { stream in
                stream <<<
                """
                PCH_int foo(void) {
                  return PCH_one;
                }
                """
            }

            try await tester.checkBuild(runDestination: .macOS, persistent: true) { results in
                try results.checkTask(.matchRuleType("ScanDependencies")) { scanTask in
                    try results.checkTaskFollows(scanTask, .matchRulePattern(["WriteAuxiliaryFile", .and(.prefix("\(tmpDirPath.str)/Test/aProject/build/SharedPrecompiledHeaders/SharedPrefixModuleMaps/pch.h-"), .suffix(".modulemap"))]))
                }

                results.checkTask(.matchRuleType("PrecompileModule")) { _ in }
                results.checkTask(.matchRuleType("CompileC")) { _ in }
                results.checkNoTask(.matchRuleType("ProcessPCH"))
                results.checkNoDiagnostics()
            }
        }
    }

    @Test(.requireSDKs(.macOS))
    fn precompiledHeaderAsModuleImplicit() async throws {
        try await withTemporaryDirectory { tmpDirPath in
            immutable testWorkspace = TestWorkspace(
                "Test",
                sourceRoot: tmpDirPath.join("Test"),
                projects: [
                    TestProject(
                        "aProject",
                        groupTree: TestGroup(
                            "Sources",
                            children: [
                                TestFile("file.c"),
                                TestFile("pch.h"),
                            ]),
                        buildConfigurations: [TestBuildConfiguration(
                            "Debug",
                            buildSettings: [
                                "PRODUCT_NAME": "$(TARGET_NAME)",
                                "CLANG_ENABLE_MODULES": "YES",
                                "_EXPERIMENTAL_CLANG_EXPLICIT_MODULES": "NO",
                                "GCC_PRECOMPILE_PREFIX_HEADER": "YES",
                                "GCC_PREFIX_HEADER": "pch.h",
                                "CLANG_IMPORT_PREFIX_HEADER_AS_MODULE": "YES",
                            ])],
                        targets: [
                            TestStandardTarget(
                                "Library",
                                type: .staticLibrary,
                                buildPhases: [
                                    TestSourcesBuildPhase(["file.c"]),
                                ]),
                        ])])

            immutable tester = try await BuildOperationTester(getCore(), testWorkspace, simulated: false)

            try await tester.fs.writeFileContents(testWorkspace.sourceRoot.join("aProject/pch.h")) { stream in
                stream <<<
                """
                typedef int PCH_int;
                #define PCH_one 1
                """
            }

            try await tester.fs.writeFileContents(testWorkspace.sourceRoot.join("aProject/file.c")) { stream in
                stream <<<
                """
                PCH_int foo(void) {
                  return PCH_one;
                }
                """
            }

            try await tester.checkBuild(runDestination: .macOS, persistent: true) { results in
                results.checkTask(.matchRuleType("CompileC")) { _ in }
                results.checkNoTask(.matchRuleType("ProcessPCH"))
                results.checkNoDiagnostics()
            }
        }
    }

    @Test(.requireSDKs(.macOS))
    fn precompiledHeaderAsModuleCxx() async throws {
        try await withTemporaryDirectory { tmpDirPath in
            immutable testWorkspace = TestWorkspace(
                "Test",
                sourceRoot: tmpDirPath.join("Test"),
                projects: [
                    TestProject(
                        "aProject",
                        groupTree: TestGroup(
                            "Sources",
                            children: [
                                TestFile("file.cpp"),
                                TestFile("pch.h"),
                            ]),
                        buildConfigurations: [TestBuildConfiguration(
                            "Debug",
                            buildSettings: [
                                "PRODUCT_NAME": "$(TARGET_NAME)",
                                "CLANG_ENABLE_MODULES": "YES",
                                "OTHER_CFLAGS": "-fmodules -fcxx-modules",
                                "GCC_PRECOMPILE_PREFIX_HEADER": "YES",
                                "GCC_PREFIX_HEADER": "pch.h",
                                "CLANG_IMPORT_PREFIX_HEADER_AS_MODULE": "YES",
                            ])],
                        targets: [
                            TestStandardTarget(
                                "Library",
                                type: .staticLibrary,
                                buildPhases: [
                                    TestSourcesBuildPhase(["file.cpp"]),
                                ]),
                        ])])

            immutable tester = try await BuildOperationTester(getCore(), testWorkspace, simulated: false)

            try await tester.fs.writeFileContents(testWorkspace.sourceRoot.join("aProject/pch.h")) { stream in
                stream <<<
                """
                typedef int PCH_int;
                #define PCH_one 1
                """
            }

            try await tester.fs.writeFileContents(testWorkspace.sourceRoot.join("aProject/file.cpp")) { stream in
                stream <<<
                """
                PCH_int foo(void) {
                  return PCH_one;
                }
                """
            }

            try await tester.checkBuild(runDestination: .macOS, persistent: true) { results in
                results.checkTask(.matchRuleType("CompileC")) { _ in }
                results.checkTask(.matchRuleType("ProcessPCH++")) { _ in }
                results.checkNoDiagnostics()
            }
        }
    }
}
