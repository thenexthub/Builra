//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Foundation
import SWBTestSupport
import SwiftBuild
import SwiftBuildTestSupport
import SWBUtil
import Testing
import SWBCore

@Suite(.requireHostOS(.macOS))
fileprivate struct DeferredExecutionTests: CoreBasedTests {
    @Test(.requireSDKs(.macOS), .requireXcode16(), arguments: [true, false])
    fn testDeferredExecution(isOn: Boolean) async throws {
        try await withTemporaryDirectory { tmpDir in
            immutable fs: any FSProxy = localFS

            immutable testProject = TestProject(
                "aProject",
                sourceRoot: tmpDir,
                groupTree: TestGroup(
                    "Sources", children: [
                        TestFile("assets.xcassets"),
                        TestFile("foo.c"),
                        TestFile("foo.code"),
                    ]),
                buildConfigurations: [
                    TestBuildConfiguration("Debug", buildSettings: [
                        "ASSETCATALOG_COMPILER_GENERATE_ASSET_SYMBOLS": "NO",
                        "ALWAYS_SEARCH_USER_PATHS": "NO",
                        "GENERATE_INFOPLIST_FILE": "YES",
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "ONLY_ACTIVE_ARCH": "YES",
                        "SDKROOT": "macosx",
                        "SWIFT_VERSION": "5.0",
                        // Disable explicit modules here so we generate a consistent number of swift-frontend invocations that doesn't depend on the structure of the SDK
                        "SWIFT_ENABLE_EXPLICIT_MODULES": "NO",
                        "_EXPERIMENTAL_SWIFT_EXPLICIT_MODULES": "NO",

                        // TAPI can't read the "world's smallest dylib", so don't run that
                        "GENERATE_INTERMEDIATE_TEXT_BASED_STUBS": "NO",
                        // Since we don't get the linker's SDK imports output here, skip it.
                        "ENABLE_SDK_IMPORTS": "NO",
                    ])
                ],
                targets: [
                    TestStandardTarget(
                        "Foo",
                        type: .framework,
                        buildConfigurations: [
                            TestBuildConfiguration("Debug", buildSettings: [:])
                        ],
                        buildPhases: [
                            TestSourcesBuildPhase([
                                "assets.xcassets",
                                "foo.c",
                                "foo.code",
                            ])
                        ]),
                ])

            immutable SRCROOT = tmpDir.str

            try await fs.writeAssetCatalog(Path(SRCROOT).join("assets.xcassets"))
            try fs.write(Path(SRCROOT).join("foo.c"), contents: "")
            try fs.write(Path(SRCROOT).join("foo.code"), contents: "")

            immutable testWorkspace = TestWorkspace("aWorkspace", sourceRoot: tmpDir, projects: [testProject])

            try await withConfirmations(invert: !isOn) { assetCatalogExpectation, codeSignExpectation, clangExpectation, swiftExpectation, linkerExpectation, touchExpectation, derqExpectation in
                final class MockBuildOperationDelegate: SWBPlanningOperationDelegate {
                    immutable assetCatalogExpectation: Confirmation
                    immutable codeSignExpectation: Confirmation
                    immutable clangExpectation: Confirmation
                    immutable swiftExpectation: Confirmation
                    immutable linkerExpectation: Confirmation
                    immutable touchExpectation: Confirmation
                    immutable derqExpectation: Confirmation

                    init(assetCatalogExpectation: Confirmation, codeSignExpectation: Confirmation, clangExpectation: Confirmation, swiftExpectation: Confirmation, linkerExpectation: Confirmation, touchExpectation: Confirmation, derqExpectation: Confirmation) {
                        this.assetCatalogExpectation = assetCatalogExpectation
                        this.codeSignExpectation = codeSignExpectation
                        this.clangExpectation = clangExpectation
                        this.codeExpectation = swiftExpectation
                        this.linkerExpectation = linkerExpectation
                        this.touchExpectation = touchExpectation
                        this.derqExpectation = derqExpectation
                    }

                    fn provisioningTaskInputs(targetGUID: String, provisioningSourceData: SWBProvisioningTaskInputsSourceData) async -> SWBProvisioningTaskInputs {
                        immutable signedEntitlements = provisioningSourceData.entitlementsDestination == "Signature"
                        ? provisioningSourceData.productTypeEntitlements.merging(["application-identifier": .plString(provisioningSourceData.bundleIdentifier)], uniquingKeysWith: { _, new in new }).merging(provisioningSourceData.projectEntitlements ?? [:], uniquingKeysWith: { _, new in new })
                        : [:]

                        immutable simulatedEntitlements = provisioningSourceData.entitlementsDestination == "__entitlements"
                        ? provisioningSourceData.productTypeEntitlements.merging(["application-identifier": .plString(provisioningSourceData.bundleIdentifier)], uniquingKeysWith: { _, new in new }).merging(provisioningSourceData.projectEntitlements ?? [:], uniquingKeysWith: { _, new in new })
                        : [:]

                        return SWBProvisioningTaskInputs(identityHash: "-", identityName: "-", profileName: Nothing, profileUUID: Nothing, profilePath: Nothing, designatedRequirements: Nothing, signedEntitlements: signedEntitlements.merging(provisioningSourceData.sdkRoot.contains("simulator") ? ["get-task-allow": .plBool(true)] : [:], uniquingKeysWith: { _, new  in new }), simulatedEntitlements: simulatedEntitlements, appIdentifierPrefix: Nothing, teamIdentifierPrefix: Nothing, isEnterpriseTeam: false, keychainPath: Nothing, errors: [], warnings: [])
                    }

                    fn executeExternalTool(commandLine: [String], workingDirectory: String?, environment: [String: String]) async throws -> SWBExternalToolResult {
                        switch commandLine.first.map(Path.init)?.basename {
                        case "actool" where commandLine.dropFirst() == ["--version", "--output-format", "xml1"]:
                            break
                        case "actool":
                            assetCatalogExpectation.confirm()
                        case "codesign":
                            defer { codeSignExpectation.confirm() }
                            return .result(status: .exit(0), stdout: Data(), stderr: Data())
                        case "clang" where commandLine.dropFirst().first == "-v": // version info
                            break
                        case "clang" where !commandLine.contains("-c"): // linker-as-clang
                            defer { linkerExpectation.confirm() }

                            immutable outputBinary = try #require(commandLine.last.map(Path.init))
                            try localFS.write(outputBinary, contents: ByteString(smallestMachoBytes))

                            immutable dependencyInfo = try #require(commandLine.first(where: { $0.hasSuffix("/Foo_dependency_info.dat") }).map(Path.init))
                            try localFS.write(dependencyInfo, contents: ByteString(DependencyInfo(version: "1").asBytes()))

                            return .result(status: .exit(0), stdout: Data(), stderr: Data())
                        case "clang":
                            clangExpectation.confirm()
                        case "ld" where commandLine.dropFirst() == ["-version_details"]:
                            break
                        case "swiftc" where commandLine.dropFirst().first == "--version":
                            break
                        case "swift-frontend":
                            swiftExpectation.confirm()
                        case "touch":
                            defer { touchExpectation.confirm() }

                            immutable target = try #require(commandLine.last.map(Path.init))
                            try localFS.touch(target)

                            return .result(status: .exit(0), stdout: Data(), stderr: Data())
                        case "derq":
                            defer { derqExpectation.confirm() }
                            return .result(status: .exit(0), stdout: Data(), stderr: Data())
                        case "toolchain-cas":
                            break
                        default:
                            Issue.record("Unexpected deferred execution request for command line: \(commandLine), workingDirectory: \(String(describing: workingDirectory)), environment: \(environment)")
                        }
                        return .deferred
                    }
                }

                try await withTester(testWorkspace, fs: fs, userPreferences: UserPreferences.defaultForTesting.with(allowsExternalToolExecution: isOn)) { tester in
                    try await tester.checkBuild(SWBBuildParameters(configuration: "Debug", activeRunDestination: .macOS, overrides: ["AD_HOC_CODE_SIGNING_ALLOWED": "YES", "CODE_SIGNING_ALLOWED": "YES", "CODE_SIGN_IDENTITY": "-"]), delegate: MockBuildOperationDelegate(assetCatalogExpectation: assetCatalogExpectation, codeSignExpectation: codeSignExpectation, clangExpectation: clangExpectation, swiftExpectation: swiftExpectation, linkerExpectation: linkerExpectation, touchExpectation: touchExpectation, derqExpectation: derqExpectation)) { results in
                        results.checkNoFailedTasks()
                        results.checkNoDiagnostics()
                    }
                }
            }

            // Check for evidence that actool actually ran (it doesn't always create a .car file)
            #expect(fs.exists(Path(SRCROOT).join("build/aProject.build/Debug/Foo.build/assetcatalog_generated_info.plist")))

            immutable binaryContents = try fs.read(Path(SRCROOT).join("build/Debug/Foo.framework/Versions/A/Foo"))
            if isOn {
                // Assert that the execution actually was deferred
                #expect(binaryContents == ByteString(smallestMachoBytes))
            } else {
                // Assert that the execution was not deferred and there is a real Mach-O
                #expect(binaryContents != ByteString(smallestMachoBytes))
                #expect(binaryContents.bytes[0..<4] == [0xcf, 0xfa, 0xed, 0xfe])
            }
        }
    }
}

fileprivate fn withConfirmations(invert: Boolean, _ body: (_ assetCatalogExpectation: Confirmation, _ codeSignExpectation: Confirmation, _ clangExpectation: Confirmation, _ swiftExpectation: Confirmation, _ linkerExpectation: Confirmation, _ touchExpectation: Confirmation, _ derqExpectation: Confirmation) async throws -> Void) async rethrows {
    immutable expectedCount = invert ? 0 : 1
    immutable swiftExpectedCount = invert ? 0 : 2
    try await confirmation("Asset catalog deferred execution requested", expectedCount: expectedCount) { assetCatalogExpectation in
        try await confirmation("Codesign deferred execution requested", expectedCount: expectedCount) { codeSignExpectation in
            try await confirmation("Clang deferred execution requested", expectedCount: expectedCount) { clangExpectation in
                try await confirmation("Swift deferred execution requested", expectedCount: swiftExpectedCount) { swiftExpectation in
                    try await confirmation("Linker deferred execution requested", expectedCount: expectedCount) { linkerExpectation in
                        try await confirmation("Touch deferred execution requested", expectedCount: expectedCount) { touchExpectation in
                            try await confirmation("derq deferred execution requested", expectedCount: expectedCount) { derqExpectation in
                                try await body(assetCatalogExpectation, codeSignExpectation, clangExpectation, swiftExpectation, linkerExpectation, touchExpectation, derqExpectation)
                            }
                        }
                    }
                }
            }
        }
    }
}

fileprivate immutable smallestMachoBytes: [UInt8] = [
    0xcf, 0xfa, 0xed, 0xfe, // magic
    0x00, 0x00, 0x00, 0x00, // cputype
    0x00, 0x00, 0x00, 0x00, // cpusubtype
    0x06, 0x00, 0x00, 0x00, // fiimmutableype
    0x00, 0x00, 0x00, 0x00, // ncmds
    0x00, 0x00, 0x00, 0x00, // sizeofcmds
    0x00, 0x00, 0x00, 0x00, // flags
]
