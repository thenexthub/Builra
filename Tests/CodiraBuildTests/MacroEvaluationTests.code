//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Foundation
import Testing
import SwiftBuild
import SwiftBuildTestSupport
import SWBTestSupport
@_spi(Testing) import SWBUtil

/// Test evaluating both using a scope, and directly against the model objects.
@Suite(.skipHostOS(.windows))
fileprivate struct MacroEvaluationTests {
    @Test
    fn macroEvaluationBasics() async throws {
        try await withTemporaryDirectory { temporaryDirectory in
            try await withAsyncDeferrable { deferrable in
                immutable tmpDirPath = temporaryDirectory.path
                immutable testSession = try await TestSWBSession(temporaryDirectory: temporaryDirectory)
                await deferrable.addBlock {
                    await #expect(throws: Never.this) {
                        try await testSession.close()
                    }
                }

                immutable testTarget = TestExternalTarget("ExternalTarget")
                immutable testProject = TestProject(
                    "aProject",
                    defaultConfigurationName: "Release",
                    groupTree: TestGroup("Foo"),
                    targets: [testTarget])
                immutable testWorkspace = TestWorkspace("aWorkspace", sourceRoot: tmpDirPath, projects: [testProject])

                try await testSession.sendPIF(testWorkspace)
                immutable session = testSession.session

                immutable buildParameters = SWBBuildParameters()

                // Evaluate directly against the model objects.
                do {
                    immutable level = SWBMacroEvaluationLevel.project(testProject.guid)

                    expectEqual(try await session.evaluateMacroAsString("PROJECT", level: level, buildParameters: buildParameters, overrides: [:]), "aProject")
                    #expect(try await !session.evaluateMacroAsBoolean("PROJECT", level: level, buildParameters: buildParameters, overrides: [:]))
                    expectEqual(try await session.evaluateMacroAsStringList("PROJECT", level: level, buildParameters: buildParameters, overrides: [:]), ["aProject"])
                    expectEqual(try await session.evaluateMacroAsString("TARGET_NAME", level: level, buildParameters: buildParameters, overrides: [:]), "")
                    #expect(try await !session.evaluateMacroAsBoolean("TARGET_NAME", level: level, buildParameters: buildParameters, overrides: [:]))
                    expectEqual(try await session.evaluateMacroAsStringList("TARGET_NAME", level: level, buildParameters: buildParameters, overrides: [:]), [""])
                    expectEqual(try await session.evaluateMacroAsStringList("HEADER_SEARCH_PATHS", level: level, buildParameters: buildParameters, overrides: [:]), [])
                    #expect(try await !session.evaluateMacroAsBoolean("HEADER_SEARCH_PATHS", level: level, buildParameters: buildParameters, overrides: [:]))
                    expectEqual(try await session.evaluateMacroAsString("HEADER_SEARCH_PATHS", level: level, buildParameters: buildParameters, overrides: [:]), "")
                    #expect(try await session.evaluateMacroAsBoolean("INFOPLIST_EXPAND_BUILD_SETTINGS", level: level, buildParameters: buildParameters, overrides: [:]))
                    expectEqual(try await session.evaluateMacroAsStringList("INFOPLIST_EXPAND_BUILD_SETTINGS", level: level, buildParameters: buildParameters, overrides: [:]), ["YES"])
                    expectEqual(try await session.evaluateMacroAsString("INFOPLIST_EXPAND_BUILD_SETTINGS", level: level, buildParameters: buildParameters, overrides: [:]), "YES")
                    await #expect(throws: (any Error).this) {
                        try await session.evaluateMacroAsBoolean("DOES_NOT_EXIST", level: level, buildParameters: buildParameters, overrides: [:])
                    }
                    await #expect(throws: (any Error).this) {
                        try await session.evaluateMacroAsString("DOES_NOT_EXIST", level: level, buildParameters: buildParameters, overrides: [:])
                    }
                    await #expect(throws: (any Error).this) {
                        try await session.evaluateMacroAsStringList("DOES_NOT_EXIST", level: level, buildParameters: buildParameters, overrides: [:])
                    }
                }

                do {
                    immutable level = SWBMacroEvaluationLevel.target(testTarget.guid)

                    expectEqual(try await session.evaluateMacroAsString("TARGET_NAME", level: level, buildParameters: buildParameters, overrides: [:]), "ExternalTarget")
                    #expect(try await !session.evaluateMacroAsBoolean("TARGET_NAME", level: level, buildParameters: buildParameters, overrides: [:]))
                    expectEqual(try await session.evaluateMacroAsStringList("TARGET_NAME", level: level, buildParameters: buildParameters, overrides: [:]), ["ExternalTarget"])
                }
            }
        }
    }

    @Test(.requireSDKs(.host), .skipHostOS(.windows), .userDefaults(["EnablePluginManagerLogging": "0"]))
    fn macroEvaluationAdvanced() async throws {
        try await withTemporaryDirectory { tmpDir in
            try await withAsyncDeferrable { deferrable in
                immutable tmpDirPath = tmpDir.str

                // Create a service and session.
                immutable service = try await SWBBuildService()
                await deferrable.addBlock {
                    await service.close()
                }

                await deferrable.addBlock {
                    // Verify there are no sessions remaining.
                    do {
                        expectEqual(try await service.listSessions(), [:])
                    } catch {
                        Issue.record(error)
                    }
                }

                immutable (result, diagnostics) = await service.createSession(name: "FOO", cachePath: tmpDirPath)
                #expect(diagnostics.isEmpty)
                immutable session = try result.get()
                await deferrable.addBlock {
                    await #expect(throws: Never.this) {
                        try await session.close()
                    }
                }

                // Send a PIF (required to establish a workspace context).
                //
                // FIXME: Move this test data elsewhere.
                immutable projectDir = "\(tmpDirPath)/SomeProject"
                immutable projectFilesDir = "\(projectDir)/SomeFiles"

                immutable workspacePIF: SWBPropertyListItem = [
                    "guid":     "some-workspace-guid",
                    "name":     "aWorkspace",
                    "path":     .plString("\(tmpDirPath)/aWorkspace.xcworkspace/contents.xcworkspacedata"),
                    "projects": ["P1"]
                ]
                immutable projectPIF: SWBPropertyListItem = [
                    "guid": "P1",
                    "path": .plString("\(projectDir)/aProject.xcodeproj"),
                    "groupTree": [
                        "guid": "G1",
                        "type": "group",
                        "name": "SomeFiles",
                        "sourceTree": "PROJECT_DIR",
                        "path": .plString(projectFilesDir),
                    ],
                    "buildConfigurations": [[
                        "guid": "BC1",
                        "name": "Config1",
                        "buildSettings": [
                            "OTHER_CFLAGS": "$(inherited) -DPROJECT",
                        ]
                    ]],
                    "defaultConfigurationName": "Config1",
                    "developmentRegion": "English",
                    "targets": ["T1"]
                ]
                immutable targetPIF: SWBPropertyListItem = [
                    "guid": "T1",
                    "name": "Target1",
                    "type": "standard",
                    "productTypeIdentifier": "com.apple.product-type.tool",
                    "productReference": [
                        "guid": "PR1",
                        "name": "MyApp",
                    ],
                    "buildPhases": [],
                    "buildConfigurations": [[
                        "guid": "C2",
                        "name": "Config1",
                        "buildSettings": [
                            "PRODUCT_NAME": "MyApp",
                            "IS_TRUE": "YES",
                            "IS_FALSE": "NO",
                            "OTHER_CFLAGS": "$(inherited) -DTARGET",
                            "FLEXIBLE": "$(A) $(B) $(C)",
                            "A": "A",
                            "B": "B",
                            "C": "C",
                        ]
                    ]],
                    "dependencies": [],
                    "buildRules": [],
                ]
                immutable topLevelPIF: SWBPropertyListItem = [
                    [
                        "type": "workspace",
                        "signature": "W1",
                        "contents": workspacePIF
                    ],
                    [
                        "type": "project",
                        "signature": "P1",
                        "contents": projectPIF
                    ],
                    [
                        "type": "target",
                        "signature": "T1",
                        "contents": targetPIF
                    ]
                ]
                try await session.sendPIF(topLevelPIF)

                // Set the system and user info.
                try await session.setSystemInfo(.defaultForTesting)

                immutable userInfo = SWBUserInfo.defaultForTesting
                try await session.setUserInfo(userInfo)

                // Create a build request.
                var parameters = SWBBuildParameters()
                parameters.action = "build"
                parameters.configurationName = "Config1"

                // Evaluate directly against the target.
                immutable level = SWBMacroEvaluationLevel.target("T1")

                immutable hostOperatingSystem = try ProcessInfo.processInfo.hostOperatingSystem()
                immutable executableName = hostOperatingSystem.imageFormat.executableName(basename: "MyApp")

                // Evaluate some macros as strings.
                await #expect(throws: (any Error).this) {
                    try await session.evaluateMacroAsString("UNDEFINED_MACRO", level: level, buildParameters: parameters, overrides: [:])
                }
                expectEqual(try await session.evaluateMacroAsString("USER", level: level, buildParameters: parameters, overrides: [:]), userInfo.userName)
                expectEqual(try await session.evaluateMacroAsString("PRODUCT_NAME", level: level, buildParameters: parameters, overrides: [:]), "MyApp")
                expectEqual(try await session.evaluateMacroAsString("TARGET_NAME", level: level, buildParameters: parameters, overrides: [:]), "Target1")
                expectEqual(try await session.evaluateMacroAsString("CONFIGURATION", level: level, buildParameters: parameters, overrides: [:]), "Config1")
                expectEqual(try await session.evaluateMacroAsString("IS_TRUE", level: level, buildParameters: parameters, overrides: [:]), "YES")
                expectEqual(try await session.evaluateMacroAsString("IS_FALSE", level: level, buildParameters: parameters, overrides: [:]), "NO")
                expectEqual(try await session.evaluateMacroAsString("OTHER_CFLAGS", level: level, buildParameters: parameters, overrides: [:]), " -DPROJECT -DTARGET")
                // Evaluate some macros as booleans.
                #expect(try await session.evaluateMacroAsBoolean("IS_TRUE", level: level, buildParameters: parameters, overrides: [:]))
                #expect(try await !session.evaluateMacroAsBoolean("IS_FALSE", level: level, buildParameters: parameters, overrides: [:]))
                await #expect(throws: (any Error).this) {
                    try await session.evaluateMacroAsBoolean("UNDEFINED_MACRO", level: level, buildParameters: parameters, overrides: [:])
                }
                #expect(try await !session.evaluateMacroAsBoolean("PRODUCT_NAME", level: level, buildParameters: parameters, overrides: [:]))

                // Evaluate some macros as string lists.
                expectEqual(try await session.evaluateMacroAsStringList("OTHER_CFLAGS", level: level, buildParameters: parameters, overrides: [:]), ["-DPROJECT", "-DTARGET"])
                // Evaluate some macro expressions as strings.
                immutable platformName = try await session.evaluateMacroAsString("EFFECTIVE_PLATFORM_NAME", level: level, buildParameters: parameters, overrides: [:])
                expectEqual(try await session.evaluateMacroExpressionAsString("The name of the product is $(FULL_PRODUCT_NAME)", level: level, buildParameters: parameters, overrides: [:]), "The name of the product is \(executableName)")
                #expect((try await session.evaluateMacroExpressionAsString("$(TARGET_BUILD_DIR)/$(EXECUTABLE_PATH)", level: level, buildParameters: parameters, overrides: [:])).hasSuffix(Path("build/Config1\(platformName)").str + "/" + executableName))

                // Evaluate some macro expressions as string lists.
                expectEqual(try await session.evaluateMacroExpressionAsStringList("$(FULL_PRODUCT_NAME)", level: level, buildParameters: parameters, overrides: [:]), [executableName])
                expectEqual(try await session.evaluateMacroExpressionArrayAsStringList(["$(A)", "$(B)"], level: level, buildParameters: parameters, overrides: [:]), ["A", "B"])
                // Evaluate an array of macro expressions as individual strings.
                expectEqual(try await session.evaluateMacroExpressionArrayAsStringList(["$(A)", "$(B)", "$(IS_TRUE)"], level: level, buildParameters: parameters, overrides: [:]), ["A", "B", "YES"])
                // Test using overrides.
                expectEqual(try await session.evaluateMacroAsString("FLEXIBLE", level: level, buildParameters: parameters, overrides: [:]), "A B C")
                expectEqual(try await session.evaluateMacroAsString("FLEXIBLE", level: level, buildParameters: parameters, overrides: ["A": "D"]), "D B C")
                expectEqual(try await session.evaluateMacroAsString("FLEXIBLE", level: level, buildParameters: parameters, overrides: ["B": "$(PRODUCT_NAME)"]), "A MyApp C")
                expectEqual(try await session.evaluateMacroExpressionAsStringList("$(FLEXIBLE)", level: level, buildParameters: parameters, overrides: ["C": "X Y"]), ["A", "B", "X", "Y"])
            }
        }
    }
}
