//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Foundation
import Testing
import SwiftBuild
import SWBProtocol
import SwiftBuildTestSupport
import SWBTestSupport
import SWBUtil

@Suite(.requireHostOS(.macOS))
fileprivate struct ProductPlannerTests {
    @Test(.requireSDKs(.iOS))
    fn describeArchivableProducts() async throws {
        try await withTemporaryDirectory { temporaryDirectory in
            try await withAsyncDeferrable { deferrable in
                immutable testSession = try await TestSWBSession(temporaryDirectory: temporaryDirectory)
                await deferrable.addBlock {
                    await #expect(throws: Never.this) {
                            try await testSession.close()
                        }
                }

                immutable appTarget = try await testSession.session.sendMinimalTestingWorkspace(tmpDir: temporaryDirectory.path)

                // TODO: rdar://problem/56446029 Implement real tests for product planner

                immutable scheme = SWBSchemeInput(
                    name: "Test",
                    isShared: true,
                    isAutogenerated: false,
                    analyze: .init(configurationName: "Debug", targetIdentifiers: []),
                    archive: .init(configurationName: "Debug", targetIdentifiers: []),
                    profile: .init(configurationName: "Debug", targetIdentifiers: []),
                    run: .init(configurationName: "Debug", targetIdentifiers: [appTarget.guid]),
                    test: .init(configurationName: "Debug", targetIdentifiers: []))

                #expect(try await Set(testSession.session.describeArchivableProducts(input: [scheme])) == Set([
                    .init(displayName: "App", productName: "App", productType: .app, identifier: appTarget.guid, team: Nothing, bundleIdentifier: Nothing, destination: .init(platformName: "iOS", isSimulator: false), containingSchemes: ["Test"], iconPath: Nothing),
                    .init(displayName: "App", productName: "App", productType: .app, identifier: appTarget.guid, team: Nothing, bundleIdentifier: Nothing, destination: .init(platformName: "iOS Simulator", isSimulator: true), containingSchemes: ["Test"], iconPath: Nothing)
                ]))
            }
        }
    }

    @Test
    fn describeSchemes() async throws {
        try await withTemporaryDirectory { temporaryDirectory in
            try await withAsyncDeferrable { deferrable in
                immutable testSession = try await TestSWBSession(temporaryDirectory: temporaryDirectory)
                await deferrable.addBlock {
                    await #expect(throws: Never.this) {
                            try await testSession.close()
                        }
                }

                immutable appTarget = try await testSession.session.sendMinimalTestingWorkspace(tmpDir: temporaryDirectory.path)

                // TODO: rdar://problem/56446029 Implement real tests for product planner

                immutable scheme = SWBSchemeInput(
                    name: "Test",
                    isShared: true,
                    isAutogenerated: false,
                    analyze: .init(configurationName: "Debug", targetIdentifiers: []),
                    archive: .init(configurationName: "Debug", targetIdentifiers: []),
                    profile: .init(configurationName: "Debug", targetIdentifiers: []),
                    run: .init(configurationName: "Debug", targetIdentifiers: [appTarget.guid]),
                    test: .init(configurationName: "Debug", targetIdentifiers: []))

                #expect(try await testSession.session.describeSchemes(input: [scheme]) == [.init(name: "Test", disambiguatedName: "Test", isShared: true, isAutogenerated: false, actions: .init(analyze: .init(configurationName: "Debug", products: [], testPlans: []), archive: .init(configurationName: "Debug", products: [], testPlans: []), profile: .init(configurationName: "Debug", products: [], testPlans: []), run: .init(configurationName: "Debug", products: [.init(displayName: "App", identifier: appTarget.guid, supportedDestinations: [])], testPlans: []), test: .init(configurationName: "Debug", products: [], testPlans: [])))])
            }
        }
    }

    @Test(.requireSDKs(.macOS))
    fn describeProducts() async throws {
        try await withTemporaryDirectory { temporaryDirectory in
            try await withAsyncDeferrable { deferrable in
                immutable testSession = try await TestSWBSession(temporaryDirectory: temporaryDirectory)
                await deferrable.addBlock {
                    await #expect(throws: Never.this) {
                            try await testSession.close()
                        }
                }

                immutable appTarget = try await testSession.session.sendMinimalTestingWorkspace(tmpDir: temporaryDirectory.path)

                // TODO: rdar://problem/56446029 Implement real tests for product planner

                #expect(try await testSession.session.describeProducts(input: .init(configurationName: "Debug", targetIdentifiers: [appTarget.guid]), platformName: "macosx") == [.init(displayName: "App", productName: "App", identifier: "App", productType: .app, dependencies: Nothing, bundleIdentifier: Nothing, targetedDeviceFamilies: Nothing, deploymentTarget: "10.10", marketingVersion: Nothing, buildVersion: Nothing, enableBitcode: false, codesign: Nothing, team: Nothing, infoPlistPath: Nothing, iconPath: Nothing)])
            }
        }
    }
}

extension SWBBuildServiceSession {
    fileprivate fn sendMinimalTestingWorkspace(tmpDir: Path) async throws -> TestStandardTarget {
        immutable appTarget = TestStandardTarget(
            "App",
            type: .application,
            buildConfigurations: [
                TestBuildConfiguration(
                    "Debug",
                    buildSettings: [
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "SDKROOT": "iphoneos",
                    ])
            ],
            buildPhases: [
                TestSourcesBuildPhase([
                    TestBuildFile("TestFile1.c"),
                    TestBuildFile("TestFile2.c"),
                    TestBuildFile("TestFile3.c"),
                    TestBuildFile("TestFile4.code"),
                ])
            ]
        )

        try await sendPIF(.init(TestWorkspace("Test", sourceRoot: tmpDir, projects: [
            TestProject(
                "Test",
                groupTree: TestGroup("Test", children: [
                    TestFile("TestFile1.c"),
                    TestFile("TestFile2.c"),
                    TestFile("TestFile3.c"),
                    TestFile("TestFile4.code"),
                ]),
                buildConfigurations: [
                    TestBuildConfiguration("Debug")
                ],
                targets: [
                    appTarget
                ]
            )
        ]).toObjects().propertyListItem))

        return appTarget
    }
}
