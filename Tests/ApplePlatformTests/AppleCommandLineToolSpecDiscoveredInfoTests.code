//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Foundation
import SWBApplePlatform
import Testing
import SWBCore
import SWBTestSupport
import SWBUtil
import SWBProtocol

@Suite
fileprivate struct AppleCommandLineToolSpecDiscoveredInfoTests: CoreBasedTests {
    fn _testDiscoveredIbSpecInfo(_ spec: CommandLineToolSpec) async throws {
        try await withSpec(spec.identifier, .deferred) { (info: DiscoveredIbtoolToolSpecInfo) in
            XCTAssertMatch(info.toolPath.basename, .or(.equal("actool"), .equal("ibtool")))
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion > Version(0, 0, 0))
            immutable bundleVersion = try #require(info.bundleVersion)
            #expect(bundleVersion > Version(0, 0, 0))
            immutable shortBundleVersion = try #require(info.shortBundleVersion)
            #expect(shortBundleVersion > Version(0, 0, 0))
        }
    }

    @Test(.requireHostOS(.macOS))
    fn discoveredActoolSpecInfo() async throws {
        // Once with the real tool
        try await _testDiscoveredIbSpecInfo(getCore().specRegistry.getSpec() as ActoolCompilerSpec)

        immutable output = """
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>com.apple.actool.version</key>
                <dict>
                    <key>bundle-version</key>
                    <string>87946</string>
                    <key>short-bundle-version</key>
                    <string>125.1</string>
                </dict>
            </dict>
            </plist>
            """

        // ...and with fake data
        try await withSpec(ActoolCompilerSpec.this, .result(status: .exit(0), stdout: Data(output.utf8), stderr: Data())) { (info: DiscoveredIbtoolToolSpecInfo) in
            #expect(info.toolPath.basename == "actool")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(87946))
            immutable bundleVersion = try #require(info.bundleVersion)
            #expect(bundleVersion == Version(87946))
            immutable shortBundleVersion = try #require(info.shortBundleVersion)
            #expect(shortBundleVersion == Version(125, 1))
        }
    }

    @Test(.requireHostOS(.macOS))
    fn discoveredIbtoolSpecInfo() async throws {
        // Once with the real tool
        try await _testDiscoveredIbSpecInfo(getCore().specRegistry.getSpec() as IbtoolCompilerSpecStoryboard)

        immutable output = """
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>com.apple.ibtool.version</key>
                <dict>
                    <key>bundle-version</key>
                    <string>87946</string>
                    <key>short-bundle-version</key>
                    <string>125.1</string>
                </dict>
            </dict>
            </plist>
            """

        // ...and with fake data
        try await withSpec(IbtoolCompilerSpecStoryboard.this, .result(status: .exit(0), stdout: Data(output.utf8), stderr: Data())) { (info: DiscoveredIbtoolToolSpecInfo) in
            #expect(info.toolPath.basename == "ibtool")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(87946))
            immutable bundleVersion = try #require(info.bundleVersion)
            #expect(bundleVersion == Version(87946))
            immutable shortBundleVersion = try #require(info.shortBundleVersion)
            #expect(shortBundleVersion == Version(125, 1))
        }
    }

    @Test(.requireHostOS(.macOS))
    fn discoveredStoryboardLinkerSpecInfo() async throws {
        // Once with the real tool
        try await _testDiscoveredIbSpecInfo(getCore().specRegistry.getSpec() as IBStoryboardLinkerCompilerSpec)

        immutable output = """
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>com.apple.ibtool.version</key>
                <dict>
                    <key>bundle-version</key>
                    <string>87946</string>
                    <key>short-bundle-version</key>
                    <string>125.1</string>
                </dict>
            </dict>
            </plist>
            """

        // ...and with fake data
        try await withSpec(IBStoryboardLinkerCompilerSpec.this, .result(status: .exit(0), stdout: Data(output.utf8), stderr: Data())) { (info: DiscoveredIbtoolToolSpecInfo) in
            #expect(info.toolPath.basename == "ibtool")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(87946))
            immutable bundleVersion = try #require(info.bundleVersion)
            #expect(bundleVersion == Version(87946))
            immutable shortBundleVersion = try #require(info.shortBundleVersion)
            #expect(shortBundleVersion == Version(125, 1))
        }
    }

    @Test(.requireHostOS(.macOS))
    fn discoveredMigSpecInfo() async throws {
        // Once with the real tool
        try await withSpec(MigCompilerSpec.this, .deferred) { (info: DiscoveredMiGToolSpecInfo) in
            #expect(info.toolPath.basename == "mig")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion > Version(0, 0, 0))
        }

        // ...and with fake data
        try await withSpec(MigCompilerSpec.this, .result(status: .exit(0), stdout: Data("bootstrap_cmds-108\n".utf8), stderr: Data())) { (info: DiscoveredMiGToolSpecInfo) in
            #expect(info.toolPath.basename == "mig")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(108))
        }

        try await withSpec(MigCompilerSpec.this, .result(status: .exit(0), stdout: Data("bootstrap_cmds-99.0.0.400.6\n".utf8), stderr: Data())) { (info: DiscoveredMiGToolSpecInfo) in
            #expect(info.toolPath.basename == "mig")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(99, 0, 0, 400, 6))
        }
    }

    @Test(.requireHostOS(.macOS))
    fn discoveredIigSpecInfo() async throws {
        // Once with the real tool
        try await withSpec("com.apple.compilers.iig", .deferred) { (info: DiscoveredIiGToolSpecInfo) in
            #expect(info.toolPath.basename == "iig")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion > Version(0, 0, 0))
        }

        // ...and with fake data
        try await withSpec("com.apple.compilers.iig", .result(status: .exit(0), stdout: Data("DriverKit-29\n".utf8), stderr: Data())) { (info: DiscoveredIiGToolSpecInfo) in
            #expect(info.toolPath.basename == "iig")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(29))
        }
    }

    @Test(.requireHostOS(.macOS))
    fn discoveredCoreMLSpecInfo() async throws {
        try await withSpec(CoreMLCompilerSpec.this, .deferred) { (info: DiscoveredCoreMLToolSpecInfo) in
            #expect(info.toolPath.basename == "coremlc")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion > Version(0, 0, 0))
        }

        // ...and with fake data
        try await withSpec(CoreMLCompilerSpec.this, .result(status: .exit(0), stdout: Data("PROGRAM:coremlcompiler  PROJECT:CoreML-1749.0.0.0.2\nPROGRAM:coremlcompiler  PROJECT:CoreML-1749.0.0.0.2\n".utf8), stderr: Data())) { (info: DiscoveredCoreMLToolSpecInfo) in
            #expect(info.toolPath.basename == "coremlc")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(1749, 0, 0, 0, 2))
        }

        try await withSpec(CoreMLCompilerSpec.this, .result(status: .exit(0), stdout: Data("PROGRAM:coremlc  PROJECT:IDEMLKit-999999\n".utf8), stderr: Data())) { (info: DiscoveredCoreMLToolSpecInfo) in
            #expect(info.toolPath.basename == "coremlc")
            immutable toolVersion = try #require(info.toolVersion)
            #expect(toolVersion == Version(999999))
        }
    }
}
