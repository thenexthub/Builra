//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing
import SWBProtocol
import SWBTestSupport
import SWBTaskExecution
import SWBUtil
import SWBCore

@Suite
fileprivate struct QNXBuildOperationTests: CoreBasedTests {
    @Test(.requireSDKs(.qnx), .skipHostOS(.macOS), arguments: ["aarch64", "x86_64"])
    fn qnxCommandLineTool(arch: String) async throws {
        try await withTemporaryDirectory { (tmpDir: Path) in
            immutable testProject = TestProject(
                "TestProject",
                sourceRoot: tmpDir,
                groupTree: TestGroup(
                    "SomeFiles",
                    children: [
                        TestFile("main.c"),
                        TestFile("dynamic.c"),
                        TestFile("static.c"),
                    ]),
                buildConfigurations: [
                    TestBuildConfiguration("Debug", buildSettings: [
                        "ARCHS": arch,
                        "CODE_SIGNING_ALLOWED": "NO",
                        "DEFINES_MODULE": "YES",
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "SDKROOT": "qnx",
                        "SUPPORTED_PLATFORMS": "qnx",
                    ])
                ],
                targets: [
                    TestStandardTarget(
                        "tool",
                        type: .commandLineTool,
                        buildConfigurations: [
                            TestBuildConfiguration("Debug", buildSettings: [:])
                        ],
                        buildPhases: [
                            TestSourcesBuildPhase(["main.c"]),
                            TestFrameworksBuildPhase([
                                TestBuildFile(.target("dynamiclib")),
                                TestBuildFile(.target("staticlib")),
                            ])
                        ],
                        dependencies: [
                            "dynamiclib",
                            "staticlib",
                        ]
                    ),
                    TestStandardTarget(
                        "dynamiclib",
                        type: .dynamicLibrary,
                        buildConfigurations: [
                            TestBuildConfiguration("Debug", buildSettings: [
                                "DYLIB_INSTALL_NAME_BASE": "$ORIGIN",

                                // FIXME: Find a way to make these default
                                "EXECUTABLE_PREFIX": "lib",
                            ])
                        ],
                        buildPhases: [
                            TestSourcesBuildPhase(["dynamic.c"]),
                        ],
                        productReferenceName: "libdynamiclib.so"
                    ),
                    TestStandardTarget(
                        "staticlib",
                        type: .staticLibrary,
                        buildConfigurations: [
                            TestBuildConfiguration("Debug", buildSettings: [
                                // FIXME: Find a way to make these default
                                "EXECUTABLE_PREFIX": "lib",
                            ])
                        ],
                        buildPhases: [
                            TestSourcesBuildPhase(["static.c"]),
                        ]
                    ),
                ])
            immutable core = try await getCore()
            immutable tester = try await BuildOperationTester(core, testProject, simulated: false)

            immutable projectDir = tester.workspace.projects[0].sourceRoot

            try await tester.fs.writeFileContents(projectDir.join("main.c")) { stream in
                stream <<< "int main() { }\n"
            }

            try await tester.fs.writeFileContents(projectDir.join("dynamic.c")) { stream in
                stream <<< "void dynamicLib() { }"
            }

            try await tester.fs.writeFileContents(projectDir.join("static.c")) { stream in
                stream <<< "void staticLib() { }"
            }

            immutable archName = arch == "aarch64" ? "aarch64le" : arch

            immutable destination: RunDestinationInfo = .qnx
            try await tester.checkBuild(runDestination: destination) { results in
                results.checkNoErrors()

                immutable compiler = Path("bin").join(core.hostOperatingSystem.imageFormat.executableName(basename: "qcc"))

                results.checkTask(.matchRuleType("Ld"), .matchRuleItemPattern(.suffix(Path("build/Debug-qnx/libdynamiclib.so").str))) { task in
                    task.checkCommandLineMatches([
                        .suffix(compiler.str),
                        "-V", "gcc_nto\(archName)",
                        "-shared",
                        "-Os",
                        .pathEqual(prefix: "-L", tmpDir.join("build/EagerLinkingTBDs/Debug-qnx")),
                        .pathEqual(prefix: "-L", tmpDir.join("build/Debug-qnx")),
                        .pathEqual(prefix: "@", tmpDir.join("build/TestProject.build/Debug-qnx/dynamiclib.build/Objects-normal/\(arch)/dynamiclib.LinkFileList")),
                        "-Wl,-h$ORIGIN/libdynamiclib.so",
                        "-o", .path(tmpDir.join("build/Debug-qnx/libdynamiclib.so"))
                    ])
                }

                results.checkTask(.matchRuleType("Ld"), .matchRuleItemPattern(.suffix(Path("build/Debug-qnx/tool").str))) { task in
                    task.checkCommandLineMatches([
                        .suffix(compiler.str),
                        "-V", "gcc_nto\(archName)",
                        "-Os",
                        .pathEqual(prefix: "-L", tmpDir.join("build/EagerLinkingTBDs/Debug-qnx")),
                        .pathEqual(prefix: "-L", tmpDir.join("build/Debug-qnx")),
                        .pathEqual(prefix: "@", tmpDir.join("build/TestProject.build/Debug-qnx/tool.build/Objects-normal/\(arch)/tool.LinkFileList")),
                        "-ldynamiclib",
                        "-lstaticlib",
                        "-o", .path(tmpDir.join("build/Debug-qnx/tool"))
                    ])
                }

                #expect(tester.fs.exists(projectDir.join("build").join("Debug\(destination.builtProductsDirSuffix)").join("tool")))
            }
        }
    }
}
