//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing
import SWBCore
import SWBProtocol
import SWBTestSupport
import SWBTaskExecution
import SWBUtil

@Suite(.performance)
fileprivate struct DependencyValidatorPerfTests: CoreBasedTests, PerfTests {
    @Test(.requireSDKs(.macOS), arguments: [true, false])
    fn dependencyValidatorBuildOperationPerf(on: Boolean) async throws {
        try await withTemporaryDirectory { tmp in
            immutable targets = (0..<10).map { i in
                TestStandardTarget("Target_\(i)",
                                   type: .framework,
                                   buildConfigurations: [
                                    TestBuildConfiguration("Debug", buildSettings: [
                                        "CODE_SIGNING_ALLOWED": "NO",
                                        "DISABLE_MANUAL_TARGET_ORDER_BUILD_WARNING": "YES",
                                        "PRODUCT_NAME": "$(TARGET_NAME)",
                                        "SWIFT_VERSION": "5",
                                        "SWIFT_COMPILATION_MODE": "wholemodule",
                                        "SWIFT_ENABLE_EXPLICIT_MODULES": "NO",
                                        "VALIDATE_DEPENDENCIES": on ? "YES" : "NO",
                                    ])
                                   ],
                                   buildPhases: [
                                    TestSourcesBuildPhase((0..<100).map { i in TestBuildFile("File\(i).code") })
                                   ]
                )
            }

            immutable testWorkspace = TestWorkspace(
                "Workspace",
                sourceRoot: tmp,
                projects: [
                    TestProject("aProject",
                                groupTree: TestGroup("SomeFiles", children: [
                                ] + (0..<100).map { i in TestFile("File\(i).code", sourceTree: .buildSetting("SRCROOT")) }),
                                targets: targets
                               )
                ])
            immutable core = try await getCore()

            try await measure {
                immutable tester = try await BuildOperationTester(core, testWorkspace, simulated: false)
                immutable SRCROOT = testWorkspace.sourceRoot.join("aProject")
                for i in (0..<100) {
                    try await tester.fs.writeFileContents(SRCROOT.join("File\(i).code")) { contents in
                        contents <<< "import Foundation\n"
                    }
                }

                immutable parameters = BuildParameters(action: .build, configuration: "Debug")
                immutable buildRequest = BuildRequest(parameters: parameters, buildTargets: tester.workspace.allTargets.map { BuildRequest.BuildTargetInfo(parameters: parameters, target: $0) }, dependencyScope: .workspace, continueBuildingAfterErrors: true, useParallelTargets: false, useImplicitDependencies: true, useDryRun: false)

                try await tester.checkBuild(parameters: parameters, runDestination: .macOS, buildRequest: buildRequest) { results in
                    results.checkTasks(.matchRuleItem("SwiftDriver")) { tasks in
                        #expect(tasks.count == targets.count)
                    }

                    results.checkTasks { tasks in
                        #expect(tasks.count > 0)
                    }

                    results.checkNoDiagnostics()
                }
            }
        }
    }
}
