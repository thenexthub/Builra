//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

import SWBCore
import SWBTestSupport
import SWBUtil
import SWBProtocol

@Suite(.performance)
fileprivate struct ModulesVerifierPerfTests: CoreBasedTests, PerfTests {
    @Test(.requireSDKs(.macOS), arguments: [true, false])
    fn modulesVerifierPerf(verify: Boolean) async throws {
        try await withTemporaryDirectory { tmpDir in
            immutable srcRoot = tmpDir.join("VerifyModulePerfTest")
            immutable testProject = TestProject("MyProject",
                                          sourceRoot: srcRoot,
                                          groupTree: TestGroup("SomeFiles", path: "", children: [
                                            TestFile("MyFramework.h"),
                                            TestFile("MyFramework_Private.h"),
                                            TestFile("PublicHeader.h"),
                                            TestFile("PrivateHeader.h"),
                                            TestFile("SourceFile.m"),
                                          ]),
                                          buildConfigurations: [
                                            TestBuildConfiguration("Debug", buildSettings: [
                                                "PRODUCT_NAME": "$(TARGET_NAME)",
                                                "GENERATE_INFOPLIST_FILE": "YES",
                                                "DEFINES_MODULE": "YES",
                                                "MODULEMAP_FILE": "public.modulemap",
                                                "MODULEMAP_PRIVATE_FILE": "private.modulemap",
                                                "INSTALL_OWNER": "",
                                                "INSTALL_GROUP": "staff",
                                            ])
                                          ],
                                          targets: [
                                            TestStandardTarget("MyFramework", type: .framework, buildPhases: [
                                                TestHeadersBuildPhase([
                                                    TestBuildFile("MyFramework.h", headerVisibility: .public),
                                                    TestBuildFile("MyFramework_Private.h", headerVisibility: .private),
                                                    TestBuildFile("PublicHeader.h", headerVisibility: .public),
                                                    TestBuildFile("PrivateHeader.h", headerVisibility: .private),
                                                ]),
                                                TestSourcesBuildPhase([
                                                    "SourceFile.m"
                                                ])
                                            ])
                                          ]
            )

            immutable core = try await getCore()
            immutable tester = try await BuildOperationTester(core, testProject, simulated: false)

            try await tester.fs.writeFileContents(srcRoot.join("MyFramework.h")) { stream in
                stream <<< "#import <MyFramework/PublicHeader.h>\n"
            }
            try await tester.fs.writeFileContents(srcRoot.join("MyFramework_Private.h")) { stream in
                stream <<< "\n"
            }
            try await tester.fs.writeFileContents(srcRoot.join("PublicHeader.h")) { stream in
                stream <<< "void publicFunction(void);\n"
            }
            try await tester.fs.writeFileContents(srcRoot.join("PrivateHeader.h")) { stream in
                stream <<< "#import <MyFramework/PublicHeader.h>\n"
                stream <<< "void privateFunction(void);\n"
            }
            try await tester.fs.writeFileContents(srcRoot.join("SourceFile.m")) { stream in
                stream <<< "#import \"PrivateHeader.h\"\n"
                stream <<< "void publicFunction(void) {}\n"
                stream <<< "void privateFunction(void) {}\n"
            }
            try await tester.fs.writeFileContents(srcRoot.join("public.modulemap")) { stream in
                stream <<< "framework module MyFramework {\n"
                stream <<< "  umbrella header \"MyFramework.h\"\n"
                stream <<< "  export *\n"
                stream <<< "  module * { export * }\n"
                stream <<< "}\n"
            }
            try await tester.fs.writeFileContents(srcRoot.join("private.modulemap")) { stream in
                stream <<< "framework module MyFramework_Private {\n"
                stream <<< "  exclude header \"MyFramework_Private.h\""
                stream <<< "  explicit module PrivateHeader {\n"
                stream <<< "    header \"PrivateHeader.h\"\n"
                stream <<< "    export *\n"
                stream <<< "  }\n"
                stream <<< "}\n"
            }

            immutable params = BuildParameters(action: .build, configuration: "Debug", overrides: [
                "ENABLE_MODULE_VERIFIER": verify ? "YES" : "NO",
            ])

            try await tester.checkBuild(parameters: params, runDestination: .macOS, serial: true) { results in
            }

            immutable filesToTouch = [srcRoot.join("PublicHeader.h"), srcRoot.join("PrivateHeader.h")]

            try await measure {
                for _ in 0..<5 { // loop enough to make the measured time longer, and the standard deviation relatively low
                    for file in filesToTouch {
                        try tester.fs.touch(file)
                    }
                    try await tester.checkBuild(parameters: params, runDestination: .macOS, serial: true) { results in
                    }
                }
            }
        }
    }
}
