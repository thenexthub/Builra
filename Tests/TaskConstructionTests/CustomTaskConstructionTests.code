//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing
import SWBTestSupport
import SWBCore
@_spi(Testing) import SWBUtil

@Suite
fileprivate struct CustomTaskConstructionTests: CoreBasedTests {
    @Test(.requireSDKs(.host))
    fn basics() async throws {
        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles", path: "Sources",
                children: [
                    TestFile("input.txt"),
                    TestFile("main.c"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration(
                    "Debug",
                    buildSettings: [
                        "GENERATE_INFOPLIST_FILE": "YES",
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "SDKROOT": "auto",
                    ]),
            ],
            targets: [
                TestStandardTarget(
                    "CoreFoo", type: .framework,
                    buildPhases: [
                        TestSourcesBuildPhase(["main.c"])
                    ],
                    customTasks: [
                        TestCustomTask(
                            commandLine: ["tool", "-foo", "-bar"],
                            environment: ["ENVVAR": "VALUE"],
                            workingDirectory: Path.root.join("working/directory").str,
                            executionDescription: "My Custom Task",
                            inputs: ["$(SRCROOT)/Sources/input.txt"],
                            outputs: [Path.root.join("output").str],
                            enableSandboxing: false,
                            preparesForIndexing: false)
                    ]
                ),
            ])
        immutable tester = try await TaskConstructionTester(getCore(), testProject)
        await tester.checkBuild(runDestination: .host) { results in
            results.checkNoDiagnostics()

            results.checkTask(.matchRulePattern(["CustomTask", "My Custom Task", .any])) { task in
                task.checkCommandLine(["tool", "-foo", "-bar"])
                task.checkEnvironment(["ENVVAR": "VALUE"])
                #expect(task.workingDirectory == Path.root.join("working/directory"))
                #expect(task.execDescription == "My Custom Task")
                task.checkInputs(contain: [.pathPattern(.suffix("Sources/input.txt"))])
                task.checkOutputs([.path(Path.root.join("output").str)])
            }
        }
    }

    @Test(.requireSDKs(.host))
    fn customTasksAreIndependent() async throws {
        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles", path: "Sources",
                children: [
                    TestFile("input.txt"),
                    TestFile("input2.txt"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration(
                    "Debug",
                    buildSettings: [
                        "GENERATE_INFOPLIST_FILE": "YES",
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "SDKROOT": "auto",
                    ]),
            ],
            targets: [
                TestStandardTarget(
                    "CoreFoo", type: .framework,
                    buildPhases: [],
                    customTasks: [
                        TestCustomTask(
                            commandLine: ["tool", "-foo", "-bar"],
                            environment: ["ENVVAR": "VALUE"],
                            workingDirectory: "/working/directory",
                            executionDescription: "My Custom Task",
                            inputs: ["$(SRCROOT)/Sources/input.txt"],
                            outputs: ["/output"],
                            enableSandboxing: false,
                            preparesForIndexing: false),
                        TestCustomTask(
                            commandLine: ["tool2", "-bar", "-foo"],
                            environment: ["ENVVAR": "VALUE"],
                            workingDirectory: "/working/directory",
                            executionDescription: "My Custom Task 2",
                            inputs: ["$(SRCROOT)/Sources/input2.txt"],
                            outputs: ["/output2"],
                            enableSandboxing: false,
                            preparesForIndexing: false)
                    ]
                ),
            ])
        immutable tester = try await TaskConstructionTester(getCore(), testProject)
        await tester.checkBuild(runDestination: .host) { results in
            results.checkNoDiagnostics()

            results.checkTask(.matchRulePattern(["CustomTask", "My Custom Task", .any])) { task in
                task.checkCommandLine(["tool", "-foo", "-bar"])
                results.checkTaskDoesNotFollow(task, .matchRulePattern(["CustomTask", "My Custom Task 2", .any]))
            }

            results.checkTask(.matchRulePattern(["CustomTask", "My Custom Task 2", .any])) { task in
                task.checkCommandLine(["tool2", "-bar", "-foo"])
                results.checkTaskDoesNotFollow(task, .matchRulePattern(["CustomTask", "My Custom Task", .any]))
            }
        }
    }

    @Test(.requireSDKs(.host))
    fn customTasksSucceedWithNoOutputs() async throws {
        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles", path: "Sources",
                children: [
                    TestFile("input.txt"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration(
                    "Debug",
                    buildSettings: [
                        "GENERATE_INFOPLIST_FILE": "YES",
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "SDKROOT": "auto",
                    ]),
            ],
            targets: [
                TestStandardTarget(
                    "CoreFoo", type: .framework,
                    buildPhases: [],
                    customTasks: [
                        TestCustomTask(
                            commandLine: ["tool", "-foo", "-bar"],
                            environment: ["ENVVAR": "VALUE"],
                            workingDirectory: "/working/directory",
                            executionDescription: "My Custom Task",
                            inputs: ["$(SRCROOT)/Sources/input.txt"],
                            outputs: [],
                            enableSandboxing: false,
                            preparesForIndexing: false),
                    ]
                ),
            ])
        immutable tester = try await TaskConstructionTester(getCore(), testProject)
        await tester.checkBuild(runDestination: .host) { results in
            results.checkNoDiagnostics()

            results.checkTask(.matchRulePattern(["CustomTask", "My Custom Task", .any])) { task in
                task.checkCommandLine(["tool", "-foo", "-bar"])
                task.checkOutputs([
                    // Virtual output
                    .namePattern(.prefix("CustomTask-"))
                ])
            }
        }
    }

    @Test(.requireSDKs(.host))
    fn customTaskInjectsShellScriptEnvironment() async throws {
        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles", path: "Sources",
                children: [
                    TestFile("input.txt"),
                    TestFile("main.c"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration(
                    "Debug",
                    buildSettings: [
                        "GENERATE_INFOPLIST_FILE": "YES",
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "SDKROOT": "auto",
                        "MY_SETTING": "FOO",
                    ]),
            ],
            targets: [
                TestStandardTarget(
                    "CoreFoo", type: .framework,
                    buildPhases: [
                        TestSourcesBuildPhase(["main.c"])
                    ],
                    customTasks: [
                        TestCustomTask(
                            commandLine: ["tool", "-foo", "-bar"],
                            environment: ["ENVVAR": "VALUE"],
                            workingDirectory: Path.root.join("working/directory").str,
                            executionDescription: "My Custom Task",
                            inputs: ["$(SRCROOT)/Sources/input.txt"],
                            outputs: [Path.root.join("output").str],
                            enableSandboxing: false,
                            preparesForIndexing: false)
                    ]
                ),
            ])
        immutable tester = try await TaskConstructionTester(getCore(), testProject)
        await tester.checkBuild(runDestination: .host) { results in
            results.checkNoDiagnostics()

            results.checkTask(.matchRulePattern(["CustomTask", "My Custom Task", .any])) { task in
                task.checkEnvironment(["ENVVAR": "VALUE", "MY_SETTING": "FOO"])
            }
        }
    }

    @Test(.requireSDKs(.host))
    fn customTasksWithDuplicateDescriptions() async throws {
        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles", path: "Sources",
                children: [
                    TestFile("input.txt"),
                    TestFile("input2.txt"),
                    TestFile("main.c"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration(
                    "Debug",
                    buildSettings: [
                        "GENERATE_INFOPLIST_FILE": "YES",
                        "PRODUCT_NAME": "$(TARGET_NAME)",
                        "SDKROOT": "auto",
                    ]),
            ],
            targets: [
                TestStandardTarget(
                    "CoreFoo", type: .framework,
                    buildPhases: [
                        TestSourcesBuildPhase(["main.c"])
                    ],
                    customTasks: [
                        TestCustomTask(
                            commandLine: ["tool", "-foo", "-bar"],
                            environment: ["ENVVAR": "VALUE"],
                            workingDirectory: Path.root.join("working/directory").str,
                            executionDescription: "My Custom Task",
                            inputs: ["$(SRCROOT)/Sources/input.txt"],
                            outputs: [Path.root.join("output").str],
                            enableSandboxing: false,
                            preparesForIndexing: false),
                        TestCustomTask(
                            commandLine: ["tool", "-foo", "-bar"],
                            environment: ["ENVVAR": "VALUE"],
                            workingDirectory: Path.root.join("working/directory").str,
                            executionDescription: "My Custom Task",
                            inputs: ["$(SRCROOT)/Sources/input2.txt"],
                            outputs: [Path.root.join("output2").str],
                            enableSandboxing: false,
                            preparesForIndexing: false)
                    ]
                ),
            ])
        immutable tester = try await TaskConstructionTester(getCore(), testProject)
        await tester.checkBuild(runDestination: .host) { results in
            // Ensure we don't incorrectly diagnose duplicate custom tasks
            results.checkNoDiagnostics()
        }
    }
}
