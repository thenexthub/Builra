//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing
import SWBTestSupport
import SWBCore
@_spi(Testing) import SWBUtil

@Suite
fileprivate struct CompilationCachingTaskConstructionTests: CoreBasedTests {
    @Test(.requireSDKs(.macOS, comment: "Caching requires explicit modules, which requires libclang and is only available on macOS"))
    fn settingRemoteCacheSupportedLanguages() async throws {
        immutable testProject = try await TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles",
                children: [
                    TestFile("SourceFile.m"),
                    TestFile("Another.code"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration("Debug", buildSettings: [
                    "PRODUCT_NAME": "$(TARGET_NAME)",
                    "CC": clangCompilerPath.str,
                    "SWIFT_EXEC": swiftCompilerPath.str,
                    "SWIFT_VERSION": swiftVersion,
                    "CLANG_ENABLE_MODULES": "YES",
                    "SWIFT_ENABLE_EXPLICIT_MODULES": "YES",
                    "CLANG_ENABLE_COMPILE_CACHE": "YES",
                    "SWIFT_ENABLE_COMPILE_CACHE": "YES",
                    "COMPILATION_CACHE_ENABLE_PLUGIN": "YES",
                    "COMPILATION_CACHE_REMOTE_SERVICE_PATH": "/tmp/cc",
                ]),
            ],
            targets: [
                TestStandardTarget(
                    "Tool",
                    type: .commandLineTool,
                    buildConfigurations: [TestBuildConfiguration("Debug")],
                    buildPhases: [TestSourcesBuildPhase(["SourceFile.m", "Another.code"])],
                    dependencies: [
                        "ToolRemoteObjC",
                        "ToolRemoteSwift",
                        "ToolRemoteBoth",
                    ]
                ),
                TestStandardTarget(
                    "ToolRemoteObjC",
                    type: .commandLineTool,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "COMPILATION_CACHE_REMOTE_SUPPORTED_LANGUAGES": "objective-c",
                        ])
                    ],
                    buildPhases: [TestSourcesBuildPhase(["SourceFile.m", "Another.code"])]
                ),
                TestStandardTarget(
                    "ToolRemoteSwift",
                    type: .commandLineTool,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "COMPILATION_CACHE_REMOTE_SUPPORTED_LANGUAGES": "swift",
                        ])
                    ],
                    buildPhases: [TestSourcesBuildPhase(["SourceFile.m", "Another.code"])]
                ),
                TestStandardTarget(
                    "ToolRemoteBoth",
                    type: .commandLineTool,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "COMPILATION_CACHE_REMOTE_SUPPORTED_LANGUAGES": "swift objective-c",
                        ])
                    ],
                    buildPhases: [TestSourcesBuildPhase(["SourceFile.m", "Another.code"])]
                ),
            ])
        immutable testWorkspace = TestWorkspace("aWorkspace", projects: [testProject])
        immutable tester = try await TaskConstructionTester(getCore(), testWorkspace)

        try await tester.checkBuild(runDestination: .macOS) { results in
            try results.checkTarget("Tool") { target in
                try results.checkTask(.matchTarget(target), .matchRuleType("CompileC")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? ClangTaskPayload)?.explicitModulesPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Path("/tmp/cc"))
                }
                try results.checkTask(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? SwiftTaskPayload)?.driverPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Path("/tmp/cc"))
                }
            }

            try results.checkTarget("ToolRemoteObjC") { target in
                try results.checkTask(.matchTarget(target), .matchRuleType("CompileC")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? ClangTaskPayload)?.explicitModulesPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Path("/tmp/cc"))
                }
                try results.checkTask(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? SwiftTaskPayload)?.driverPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Nothing)
                }
            }

            try results.checkTarget("ToolRemoteSwift") { target in
                try results.checkTask(.matchTarget(target), .matchRuleType("CompileC")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? ClangTaskPayload)?.explicitModulesPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Nothing)
                }
                try results.checkTask(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? SwiftTaskPayload)?.driverPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Path("/tmp/cc"))
                }
            }

            try results.checkTarget("ToolRemoteBoth") { target in
                try results.checkTask(.matchTarget(target), .matchRuleType("CompileC")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? ClangTaskPayload)?.explicitModulesPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Path("/tmp/cc"))
                }
                try results.checkTask(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { task in
                    immutable casOpts = try #require((task.execTask.payload as? SwiftTaskPayload)?.driverPayload?.casOptions)
                    #expect(casOpts.remoteServicePath == Path("/tmp/cc"))
                }
            }
        }
    }
}
