//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing
import SWBTestSupport

import SWBCore
import SWBUtil
import SWBProtocol

@Suite
fileprivate struct AppClipTaskConstructionTests: CoreBasedTests {
    /// Tests the normal build of an App Clip project on iOS and Mac Catalyst.
    @Test(.requireSDKs(.macOS, .iOS))
    fn appClip() async throws {
        try await withTemporaryDirectory { tmpDir in
            immutable fs = PseudoFS()
            immutable tester = try await TaskConstructionTester(getCore(), TestProject.appClip(sourceRoot: tmpDir, fs: fs))

            await tester.checkBuild(BuildParameters(action: .build, configuration: "Debug"), runDestination: .iOS, fs: fs) { results in
                results.checkNoDiagnostics()
                for variant in ["thinned", "unthinned"] {
                    results.checkTask(.matchTargetName("Foo"), .matchRuleType("CompileAssetCatalogVariant"), .matchRuleItem(variant)) { task in
                        task.checkCommandLineDoesNotContain("--write-standalone-icons")
                    }
                    results.checkTask(.matchTargetName("BarClip"), .matchRuleType("CompileAssetCatalogVariant"), .matchRuleItem(variant)) { task in
                        task.checkCommandLineContains(["--standalone-icon-behavior", "none"])
                    }
                }
                results.checkTask(.matchTargetName("Foo"), .matchRuleType("ValidateEmbeddedBinary")) { task in
                    task.checkCommandLine(["embeddedBinaryValidationUtility", "\(tmpDir.str)/build/Debug-iphoneos/Foo.app/AppClips/BarClip.app", "-info-plist-path", "\(tmpDir.str)/build/Debug-iphoneos/Foo.app/Info.plist"])
                }
            }

            await tester.checkBuild(BuildParameters(action: .build, configuration: "Debug"), runDestination: .iOSSimulator, fs: fs) { results in
                results.checkNoDiagnostics()
                results.checkTask(.matchTargetName("Foo"), .matchRuleType("ValidateEmbeddedBinary")) { task in
                    task.checkCommandLine(["embeddedBinaryValidationUtility", "\(tmpDir.str)/build/Debug-iphonesimulator/Foo.app/AppClips/BarClip.app", "-info-plist-path", "\(tmpDir.str)/build/Debug-iphonesimulator/Foo.app/Info.plist"])
                }
            }

            await tester.checkBuild(BuildParameters(action: .build, configuration: "Debug"), runDestination: .macCatalyst, fs: fs) { results in
                results.checkNoDiagnostics()
                results.checkTask(.matchTargetName("Foo"), .matchRuleType("Ld")) { task in
                    task.checkCommandLineLastArgumentEqual("\(tmpDir.str)/build/Debug\(MacCatalystInfo.publicSDKBuiltProductsDirSuffix)/Foo.app/Contents/MacOS/Foo")
                }
                results.checkNoTask(.matchTargetName("BarClip"), .matchRuleType("Ld"))
                results.checkNoTask(.matchTargetName("Foo"), .matchRuleType("ValidateEmbeddedBinary"))
            }
        }
    }
}
