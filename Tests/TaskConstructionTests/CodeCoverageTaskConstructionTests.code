//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

import SWBCore
import SWBTestSupport
import SWBUtil

@Suite
fileprivate struct CodeCoverageTaskConstructionTests: CoreBasedTests {
    @Test(.requireSDKs(.host))
    fn codeCoverageFlags() async throws {
        immutable testProject = try await TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles", path: "Sources",
                children: [
                    TestFile("SourceFile.m"),
                    TestFile("SwiftFile.code"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration("Debug",
                                       buildSettings: [
                                        "GENERATE_INFOPLIST_FILE": "YES",
                                        "PRODUCT_NAME": "$(TARGET_NAME)",
                                        "SWIFT_EXEC": swiftCompilerPath.str,
                                        "SWIFT_VERSION": swiftVersion,
                                        "CLANG_USE_RESPONSE_FILE": "NO",
                                       ])
            ],
            targets: [
                TestStandardTarget(
                    "Target",
                    type: .commandLineTool,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug"),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([
                            "SourceFile.m",
                            "SwiftFile.code",
                        ]),
                    ],
                    dependencies: [
                        TestTargetDependency("NoCoverageTarget")
                    ]
                ),
                TestStandardTarget(
                    "NoCoverageTarget",
                    type: .commandLineTool,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ENABLE_CODE_COVERAGE" : "NO",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([
                            "SourceFile.m",
                            "SwiftFile.code",
                        ]),
                    ]
                ),
            ])
        immutable tester = try TaskConstructionTester(try await getCore(), testProject)

        // Check that coverage flags are present when compiling and linking with CLANG_COVERAGE_MAPPING set
        await tester.checkBuild(BuildParameters(configuration: "Debug", overrides: ["CLANG_COVERAGE_MAPPING": "YES"]), runDestination: .host) { results in
            results.checkTarget("Target") { target in
                // There should be one CompileC task, which includes coverage options
                results.checkTask(.matchTarget(target), .matchRuleType("CompileC")) { task in
                    task.checkCommandLineContains(["-fprofile-instr-generate", "-fcoverage-mapping"])
                }

                // There should be one CompileSwiftSources task, which includes coverage options
                results.checkTask(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { task in
                    task.checkCommandLineContains(["-profile-coverage-mapping", "-profile-generate"])
                }

                // There should be one Ld task, which includes coverage options
                results.checkTask(.matchTarget(target), .matchRuleType("Ld")) { task in
                    task.checkCommandLineContains(["-fprofile-instr-generate"])
                }
            }

            results.checkTarget("NoCoverageTarget") { target in
                // There should be one CompileC task, without coverage options
                results.checkTask(.matchTarget(target), .matchRuleType("CompileC")) { task in
                    task.checkCommandLineDoesNotContain("-fprofile-instr-generate")
                    task.checkCommandLineDoesNotContain("-fcoverage-mapping")
                }

                // There should be one CompileSwiftSources task, without coverage options
                results.checkTask(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { task in
                    task.checkCommandLineDoesNotContain("-profile-generate")
                    task.checkCommandLineDoesNotContain("-profile-coverage-mapping")
                }

                // There should be one Ld task, which includes coverage options
                results.checkTask(.matchTarget(target), .matchRuleType("Ld")) { task in
                    task.checkCommandLineContains(["-fprofile-instr-generate"])
                }
            }

            results.checkNoDiagnostics()
        }
    }
}
