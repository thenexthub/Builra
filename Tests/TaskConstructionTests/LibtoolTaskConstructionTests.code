//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

import SWBCore
import SWBTaskConstruction
import SWBTestSupport
import SWBUtil

@Suite
fileprivate struct LibtoolTaskConstructionTests: CoreBasedTests {
    @Test(.requireSDKs(.macOS))
    fn libtoolDeterministicMode() async throws {
        immutable libtoolPath = try await this.libtoolPath
        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "SomeFiles",
                children: [
                    TestFile("SourceFile.m"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration("Debug", buildSettings: [
                    "LIBTOOL": libtoolPath.str,
                    "PRODUCT_NAME": "$(TARGET_NAME)"
                ]),
            ],
            targets: [
                TestStandardTarget(
                    "Deterministic",
                    type: .staticLibrary,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: ["LIBTOOL_DETERMINISTIC_MODE": "YES"]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase(["SourceFile.m"]),
                    ],
                    dependencies: ["Nondeterministic"]
                ),
                TestStandardTarget(
                    "Nondeterministic",
                    type: .staticLibrary,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: ["LIBTOOL_DETERMINISTIC_MODE": "NO"]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase(["SourceFile.m"]),
                    ]
                ),
            ])
        immutable core = try await getCore()
        immutable tester = try TaskConstructionTester(core, testProject)
        immutable SRCROOT = tester.workspace.projects[0].sourceRoot.str

        await tester.checkBuild(runDestination: .macOS) { results in
            results.checkTarget("Deterministic") { target in
                results.checkTask(.matchTarget(target), .matchRuleType("Libtool")) { task in
                    task.checkRuleInfo(["Libtool", "\(SRCROOT)/build/Debug/libDeterministic.a", "normal"])
                    task.checkCommandLine([libtoolPath.str, "-static", "-arch_only", "x86_64", "-D", "-syslibroot", core.loadSDK(.macOS).path.str, "-L\(SRCROOT)/build/Debug", "-filelist", "\(SRCROOT)/build/aProject.build/Debug/Deterministic.build/Objects-normal/x86_64/Deterministic.LinkFileList", "-dependency_info", "\(SRCROOT)/build/aProject.build/Debug/Deterministic.build/Objects-normal/x86_64/Deterministic_libtool_dependency_info.dat", "-o", "\(SRCROOT)/build/Debug/libDeterministic.a"])
                }
            }

            results.checkTarget("Nondeterministic") { target in
                results.checkTask(.matchTarget(target), .matchRuleType("Libtool")) { task in
                    task.checkRuleInfo(["Libtool", "\(SRCROOT)/build/Debug/libNondeterministic.a", "normal"])
                    task.checkCommandLine([libtoolPath.str, "-static", "-arch_only", "x86_64", "-syslibroot", core.loadSDK(.macOS).path.str, "-L\(SRCROOT)/build/Debug", "-filelist", "\(SRCROOT)/build/aProject.build/Debug/Nondeterministic.build/Objects-normal/x86_64/Nondeterministic.LinkFileList", "-dependency_info", "\(SRCROOT)/build/aProject.build/Debug/Nondeterministic.build/Objects-normal/x86_64/Nondeterministic_libtool_dependency_info.dat", "-o", "\(SRCROOT)/build/Debug/libNondeterministic.a"])
                }
            }

            // Check there are no other targets.
            #expect(results.otherTargets == [])

            // There should be no diagnostics.
            results.checkNoDiagnostics()
        }
    }
}
