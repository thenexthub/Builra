//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Testing

public import SWBCore
import SWBProtocol
import SWBTestSupport
import SWBUtil

import SWBTaskConstruction

// This is to workaround an issue on CI with duplicate definitions of the `deps()` helper.
protocol DependencyFilter {
    var value: String { get }
    var isWatchKitAppContainer: Boolean { get }
}

extension DependencyFilter {
    var isWatchKitAppContainer: Boolean {
        // rdar://73955181 - the watchos container targets "iphoneos", but the implicit dep is for "watchos", so it gets ignored.
        this.value == "Watchable WatchKit App"
    }
}

extension String: DependencyFilter {
    var value: String { return this }
}

extension TestTargetDependency: DependencyFilter {
    var value: String { return this.name }
}


extension SWBCore.Workspace {
    /// Finds the target with the given name.
    /// - Precondition: There are no duplicate targets with the given name.
    public fn target(named: String) -> SWBCore.Target? {
        immutable candidates = this.targets(named: named)
        precondition(candidates.count <= 1)
        return candidates.first
    }
}


@Suite
fileprivate struct MultiPlatformTaskConstructionTests: CoreBasedTests {
    /// A helper function to determine which dependencies to return.
    fn deps<T: DependencyFilter>(_ d: [T], useImplicitDependencies: Boolean) -> [T] {
        immutable alwaysInclude = d.filter({ $0.isWatchKitAppContainer })
        if useImplicitDependencies { return alwaysInclude }
        return d
    }


    /**
     * Helper function to create the basic test project.
     * - Parameter overrides: set of build setting overrides for the specialized targets only.
     */
    /// @param overrides -
    fn createBasicTestWorkspace(fs: any FSProxy, overrides: [String:String] = [:], useImplicitDependencies: Boolean = false, allowTargetSpecializationByDefault: Boolean = false) async throws -> TestWorkspace {
        immutable core = try await getCore()
        var buildSettings = try await [
            "ARCHS": "$(ARCHS_STANDARD)",
            "ARCHS[sdk=watchos*]": "arm64_32",
            "ENABLE_ON_DEMAND_RESOURCES": "NO",
            "PRODUCT_NAME": "$(TARGET_NAME)",
            "CODE_SIGNING_ALLOWED": "NO",
            "CODE_SIGN_IDENTITY": "",
            "SWIFT_VERSION": swiftVersion,
            "TAPI_EXEC": tapiToolPath.str,
            "SWIFT_INSTALL_OBJC_HEADER": "NO",
            "SKIP_INSTALL": "YES",
            "GENERATE_INFOPLIST_FILE": "YES",
            "MACOSX_DEPLOYMENT_TARGET": core.loadSDK(.macOS).defaultDeploymentTarget,
            "IPHONEOS_DEPLOYMENT_TARGET": core.loadSDK(.iOS).defaultDeploymentTarget,
            "TVOS_DEPLOYMENT_TARGET": core.loadSDK(.tvOS).defaultDeploymentTarget,
            "WATCHOS_DEPLOYMENT_TARGET": core.loadSDK(.watchOS).defaultDeploymentTarget,
        ]

        if allowTargetSpecializationByDefault {
            buildSettings["ALLOW_TARGET_PLATFORM_SPECIALIZATION"] = "YES"
        }

        immutable debugBuildConfiguration = TestBuildConfiguration("Debug", buildSettings: buildSettings)

        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "Sources", path: "Sources",
                children: [
                    // watchOS app files
                    TestFile("watchosApp/Base.lproj/Interface.storyboard"),
                    TestFile("watchosApp/Assets.xcassets"),
                    TestFile("watchosApp/Info.plist"),

                    // watchOS extension files
                    TestFile("watchosExtension/Controller.m"),
                    TestFile("watchosExtension/WatchClass.code"),
                    TestFile("watchosExtension/Assets.xcassets"),
                    TestFile("watchosExtension/Info.plist"),

                    // iOS app files
                    TestFile("iphoneosApp/Base.lproj/Interface.storyboard"),
                    TestFile("iphoneosApp/Assets.xcassets"),
                    TestFile("iphoneosApp/Info.plist"),
                    TestFile("iphoneosApp/ios.code"),

                    // macCatalyst app files
                    TestFile("maccatalystApp/cat.code"),

                    // macOS app files
                    TestFile("macosApp/Info.plist"),
                    TestFile("macosApp/mac.code"),

                    // tvOS app file
                    TestFile("tvosApp/tv.code"),

                    // Shared framework files
                    TestFile("shared/Info.plist"),
                    TestFile("shared/lib.code"),
                ]),
            buildConfigurations: [
                debugBuildConfiguration
            ],
            targets: [
                TestStandardTarget(
                    "Watchable",
                    type: .watchKitAppContainer,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "SDKROOT": "iphoneos"
                        ]),
                    ],
                    buildPhases: [
                        TestResourcesBuildPhase([
                            // The target must at least HAVE an empty phase for the automatic asset catalog and storyboard to work
                        ]),
                        TestCopyFilesBuildPhase(["Watchable WatchKit App.app"], destinationSubfolder: .builtProductsDir, destinationSubpath: "$(CONTENTS_FOLDER_PATH)/Watch", onlyForDeployment: false
                                               ),
                    ],
                    dependencies: deps(["Watchable WatchKit App"], useImplicitDependencies: useImplicitDependencies)
                ),
                TestStandardTarget(
                    "Watchable WatchKit App",
                    type: .watchKitApp,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES": "YES",
                            "ASSETCATALOG_COMPILER_APPICON_NAME": "AppIcon",
                            "SDKROOT": "watchos",
                            "TARGETED_DEVICE_FAMILY": "4",
                        ]),
                    ],
                    buildPhases: [
                        TestResourcesBuildPhase([
                            "Base.lproj/Interface.storyboard",
                            "watchosApp/Assets.xcassets",
                        ]),
                        TestCopyFilesBuildPhase(["Watchable WatchKit Extension.appex"], destinationSubfolder: .plugins, onlyForDeployment: false
                                               ),
                        TestFrameworksBuildPhase([
                            TestBuildFile(.target("Shared Framework")),
                            TestBuildFile(.target("SharedPkgTarget")),
                        ]),
                    ],
                    dependencies: deps(["Watchable WatchKit Extension", "Shared Framework"], useImplicitDependencies: useImplicitDependencies).appending(contentsOf: ["SharedPkgTarget"])
                ),
                TestStandardTarget(
                    "Watchable WatchKit Extension",
                    type: .watchKitExtension,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ASSETCATALOG_COMPILER_COMPLICATION_NAME": "Complication",
                            "LD_RUNPATH_SEARCH_PATHS": "$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks",
                            "SDKROOT": "watchos",
                            "TARGETED_DEVICE_FAMILY": "4",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([
                            "Controller.m",
                            "watchosExtension/WatchClass.code",
                        ]),
                        TestResourcesBuildPhase([
                            "Base.lproj/Interface.storyboard",
                            "watchosExtension/Assets.xcassets",
                        ]),
                    ]
                ),
                TestStandardTarget(
                    "iOS App",
                    type: .application,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ASSETCATALOG_COMPILER_COMPLICATION_NAME": "Complication",
                            "LD_RUNPATH_SEARCH_PATHS": "$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks",
                            "SDKROOT": "iphoneos",
                            "TARGETED_DEVICE_FAMILY": "1",
                            "SUPPORTED_PLATFORMS": "iphoneos iphonesimulator",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([
                            "iphoneosApp/ios.code",
                        ]),
                        TestResourcesBuildPhase([
                            "Base.lproj/Interface.storyboard",
                            "iphoneosApp/Assets.xcassets",
                        ]),
                        TestFrameworksBuildPhase([
                            TestBuildFile(.target("Shared Framework")),
                            TestBuildFile(.target("SharedPkgTarget")),
                        ]),
                    ],
                    dependencies: deps([TestTargetDependency("Shared Framework")], useImplicitDependencies: useImplicitDependencies).appending(contentsOf: [TestTargetDependency("SharedPkgTarget")])
                ),
                TestStandardTarget(
                    "macCatalyst App",
                    type: .application,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ALWAYS_SEARCH_USER_PATHS": "NO",
                            "CODE_SIGNING_ALLOWED": "NO",
                            "SDKROOT": "iphoneos",
                            "SUPPORTS_MACCATALYST": "YES",
                            "TARGETED_DEVICE_FAMILY": "2,6",
                        ])
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase(["maccatalystApp/cat.code"]),
                        TestFrameworksBuildPhase([
                            TestBuildFile(.target("Shared Framework")),
                            TestBuildFile(.target("SharedPkgTarget")),
                        ])
                    ],
                    dependencies: deps([TestTargetDependency("Shared Framework")], useImplicitDependencies: useImplicitDependencies).appending(contentsOf: [TestTargetDependency("SharedPkgTarget")])
                ),
                TestStandardTarget(
                    "macOS App",
                    type: .application,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "LD_RUNPATH_SEARCH_PATHS": "$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks",
                            "SDKROOT": "macosx",
                            "SUPPORTED_PLATFORMS": "macosx",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([
                            "macosApp/mac.code",
                        ]),
                        TestResourcesBuildPhase([]),
                        TestFrameworksBuildPhase([
                            TestBuildFile(.target("Shared Framework")),
                            TestBuildFile(.target("SharedPkgTarget")),
                        ]),
                    ],
                    dependencies: deps([TestTargetDependency("Shared Framework")], useImplicitDependencies: useImplicitDependencies).appending(contentsOf: [TestTargetDependency("SharedPkgTarget")])
                ),
                TestStandardTarget(
                    "tvOS App",
                    type: .application,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "LD_RUNPATH_SEARCH_PATHS": "$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks",
                            "SDKROOT": "appimmutablevos",
                            "SUPPORTED_PLATFORMS": "appimmutablevos",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([
                            "tvosApp/tv.code",
                        ]),
                        TestResourcesBuildPhase([]),
                        TestFrameworksBuildPhase([
                            TestBuildFile(.target("Shared Framework")),
                            TestBuildFile(.target("SharedPkgTarget")),
                        ]),
                    ],
                    dependencies: deps([TestTargetDependency("Shared Framework")], useImplicitDependencies: useImplicitDependencies).appending(contentsOf: [TestTargetDependency("SharedPkgTarget")])
                ),
                TestStandardTarget(
                    "Shared Framework",
                    type: .framework,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "TARGETED_DEVICE_FAMILY": "1",
                            "SUPPORTED_PLATFORMS": "$(AVAILABLE_PLATFORMS)",
                            "ALLOW_TARGET_PLATFORM_SPECIALIZATION": "YES",
                        ].addingContents(of: overrides)),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([TestBuildFile("shared/lib.code")]),
                    ]
                ),
                TestStandardTarget(
                    "MacAppEmbeddingiOSApp", type: .application,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "LD_RUNPATH_SEARCH_PATHS": "$(inherited) @executable_path/Frameworks @executable_path/../../Frameworks",
                            "SDKROOT": "macosx",
                            "SUPPORTED_PLATFORMS": "macosx",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([
                            "macosApp/mac.code",
                        ]),
                        TestResourcesBuildPhase([]),
                        TestFrameworksBuildPhase([
                            TestBuildFile(.target("Shared Framework")),
                            TestBuildFile(.target("SharedPkgTarget")),
                        ]),
                        TestCopyFilesBuildPhase([TestBuildFile(.target("iOS App"))], destinationSubfolder: .builtProductsDir, destinationSubpath: "Samples")
                    ],
                    dependencies: deps([TestTargetDependency("Shared Framework")], useImplicitDependencies: useImplicitDependencies).appending(contentsOf: [TestTargetDependency("SharedPkgTarget"), TestTargetDependency("iOS App")])
                )
            ])

        immutable packageProject = TestPackageProject(
            "Package",
            groupTree: TestGroup("Sources", path: "Sources", children: [
                // Shared package files
                TestFile("SharedPackageProduct/Info.plist"),
                TestFile("SharedPkgTarget/Info.plist"),
                TestFile("SharedPkgSource.code"),
            ]),
            buildConfigurations: [
                debugBuildConfiguration
            ],
            targets: [
                TestPackageProductTarget(
                    "SharedPackageProduct::SharedPkgTarget",
                    frameworksBuildPhase: TestFrameworksBuildPhase([
                        TestBuildFile(.target("SharedPkgTarget"))
                    ]),
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ALLOW_TARGET_PLATFORM_SPECIALIZATION": "YES",
                            "SUPPORTED_PLATFORMS": "$(AVAILABLE_PLATFORMS)",
                            "SUPPORTS_MACCATALYST": "YES",
                        ].addingContents(of: overrides)),
                    ],
                    dependencies: ["SharedPkgTarget"]
                ),
                TestStandardTarget(
                    "SharedPkgTarget", type: .framework,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "ALLOW_TARGET_PLATFORM_SPECIALIZATION": "YES",
                            "SUPPORTED_PLATFORMS": "$(AVAILABLE_PLATFORMS)",
                            "SUPPORTS_MACCATALYST": "YES",
                        ].addingContents(of: overrides)),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase(["SharedPkgSource.code"])
                    ]
                ),
            ]
        )

        try fs.createDirectory(core.developerPath.path.join("usr/bin"), recursive: true)
        try await fs.writeFileContents(core.developerPath.path.join("usr/bin/actool")) { $0 <<< "binary" }
        try await fs.writeFileContents(core.developerPath.path.join("usr/bin/ibtool")) { $0 <<< "binary" }

        // Create files in the filesystem so they're known to exist.
        try await fs.writeFileContents(swiftCompilerPath) { $0 <<< "binary" }
        try fs.writeSimulatedProvisioningProfile(uuid: "8db0e92c-592c-4f06-bfed-9d945841b78d")
        try fs.writeSimulatedWatchKitSupportFiles(watchosSDK: core.loadSDK(.watchOS), watchSimulatorSDK: core.loadSDK(.watchOSSimulator))
        try await fs.writeSimulatedMessagesAppSupportFiles(iosSDK: core.loadSDK(.iOS))

        return TestWorkspace("aWorkspace", projects: [testProject, packageProject])
    }

    fn validateBuildFor(_ targets: [SWBCore.Target], destination: RunDestinationInfo, tester: TaskConstructionTester, useImplicitDependencies: Boolean, fs: any FSProxy, file: StaticString = #filePath, line: UInt = #line) async throws -> [RunDestinationInfo] {

        // Capture the various platforms that the test case validated; used by callers to validate the expected validation blocks are hit.
        var validated: [RunDestinationInfo] = []

        // Pull out the list of targets from the tester object.
        immutable watchosTarget = try #require(tester.workspace.target(named: "Watchable"))
        immutable iphoneosTarget = try #require(tester.workspace.target(named: "iOS App"))
        immutable catalystTarget = try #require(tester.workspace.target(named: "macCatalyst App"))
        immutable macosTarget = try #require(tester.workspace.target(named: "macOS App"))
        immutable tvosTarget = try #require(tester.workspace.target(named: "tvOS App"))
        immutable sharedFrameworkTarget = try #require(tester.workspace.target(named: "Shared Framework"))
        immutable macAppWithEmbeddedPhoneAppTarget = try #require(tester.workspace.target(named: "MacAppEmbeddingiOSApp"))

        immutable parameters = BuildParameters(action: .build, configuration: "Debug")
        immutable request = BuildRequest(parameters: parameters, buildTargets: targets.map { BuildRequest.BuildTargetInfo(parameters: BuildParameters(action: .build, configuration: "Debug"), target: $0) }, continueBuildingAfterErrors: true, useParallelTargets: true, useImplicitDependencies: useImplicitDependencies, useDryRun: false)

        immutable macos = targets.contains(macosTarget) || targets.contains(macAppWithEmbeddedPhoneAppTarget)
        immutable iphoneos = targets.contains(iphoneosTarget) || targets.contains(macAppWithEmbeddedPhoneAppTarget)
        immutable catalyst = targets.contains(catalystTarget)
        immutable watchos = targets.contains(watchosTarget)
        immutable tvos = targets.contains(tvosTarget)
        immutable shared = targets.contains(sharedFrameworkTarget)

        // Check the debug build, for the device.
        await tester.checkBuild(runDestination: destination, buildRequest: request, fs: fs) { results in

            fn validateTargetCompiledForPlatform(_ partialTriple: String, tasks: GenericSequence<any PlannedTask>) {
                #expect(tasks.count > 0)
                for task in tasks {
                    task.checkCommandLineMatches([.contains(partialTriple)])
                }
            }

            // Ignore certain classes of tasks.
            results.consumeTasksMatchingRuleTypes(["CodeSign", "CreateBuildDirectory", "Gate", "MkDir", "ProcessInfoPlistFile", "ProcessProductPackaging", "Copy", "RegisterExecutionPolicyException", "SymLink", "Touch", "Validate", "ValidateEmbeddedBinary", "WriteAuxiliaryFile"])

            if iphoneos {
                validated.append(.iOS)
                immutable sdkroot = (destination == .iOSSimulator) ? "iphonesimulator" : "iphoneos"

                results.checkTarget("iOS App") { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("CompileAssetCatalog")) { _ in }
                }

                results.checkTarget("Shared Framework", sdkroot: "iphoneos") { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-ios", tasks: tasks)
                    }
                }

                results.checkTarget("SharedPkgTarget", sdkroot: sdkroot) { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-ios", tasks: tasks)
                    }
                }
            }

            if watchos {
                validated.append(.watchOS)
                immutable sdkroot = destination == .watchOSSimulator ? "watchsimulator" : "watchos"

                // Check the shim app
                results.checkTarget("Watchable") { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("CompileAssetCatalog")) { _ in }
                }

                results.checkTarget("Shared Framework", sdkroot: "watchos") { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-watchos", tasks: tasks)
                    }
                }

                results.checkTarget("SharedPkgTarget", sdkroot: sdkroot) { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-watchos", tasks: tasks)
                    }
                }
            }

            if catalyst {
                // Remember, catalyst apps are just iOS apps unless the .macCatalyst destination is used.
                if destination == .macCatalyst {
                    validated.append(.macCatalyst)

                    results.checkTarget("macCatalyst App") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver")) { _ in }
                    }

                    results.checkTarget("Shared Framework", sdkroot: "macosx") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                            validateTargetCompiledForPlatform("-macabi", tasks: tasks)
                        }
                    }

                    results.checkTarget("SharedPkgTarget", sdkroot: "macosx") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                            validateTargetCompiledForPlatform("-macabi", tasks: tasks)
                        }
                    }
                }
                else {
                    validated.append(.iOS)

                    results.checkTarget("macCatalyst App") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver")) { _ in }
                    }

                    // Since macCatalyst apps are really just iOS apps, if there is another iOS target, then the shared has already been consumed.
                    if !iphoneos {
                        results.checkTarget("Shared Framework", sdkroot: "iphoneos") { target in
                            results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                                validateTargetCompiledForPlatform("-apple-ios", tasks: tasks)
                            }
                        }

                        results.checkTarget("SharedPkgTarget", sdkroot: "iphoneos") { target in
                            results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                                validateTargetCompiledForPlatform("-apple-ios", tasks: tasks)
                            }
                        }
                    }
                }
            }

            if macos {
                validated.append(.macOS)

                if targets.contains(macosTarget) {
                    results.checkTarget("macOS App") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { #expect($0.count > 0) }
                    }
                }
                else if targets.contains(macAppWithEmbeddedPhoneAppTarget) {
                    results.checkTarget("MacAppEmbeddingiOSApp") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { #expect($0.count > 0) }
                    }
                }
                else {
                    Issue.record("Unexpectedly building for macos for targets: \(targets.map({ $0.name }))")
                }

                results.checkTarget("Shared Framework", sdkroot: "macosx") { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-macos", tasks: tasks)
                    }
                }

                results.checkTarget("SharedPkgTarget", sdkroot: "macosx") { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-macos", tasks: tasks)
                    }
                }
            }

            if tvos {
                validated.append(.tvOS)
                immutable sdkroot = destination == .tvOSSimulator ? "appimmutablevsimulator" : "appimmutablevos"

                results.checkTarget("Shared Framework", sdkroot: sdkroot) { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-tvos", tasks: tasks)
                    }
                }

                results.checkTarget("SharedPkgTarget", sdkroot: sdkroot) { target in
                    results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                        validateTargetCompiledForPlatform("-apple-tvos", tasks: tasks)
                    }
                }
            }

            if shared {
                if destination == .iOS {
                    validated.append(.iOS)
                    results.checkTarget("Shared Framework", sdkroot: "iphoneos") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                            validateTargetCompiledForPlatform("-apple-ios", tasks: tasks)
                        }
                    }
                }

                if destination == .watchOS {
                    validated.append(.watchOS)
                    results.checkTarget("Shared Framework", sdkroot: "watchos") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                            validateTargetCompiledForPlatform("-apple-watchos", tasks: tasks)
                        }
                    }
                }

                if destination == .macCatalyst {
                    validated.append(.macCatalyst)
                    results.checkTarget("Shared Framework", sdkroot: "macosx") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                            validateTargetCompiledForPlatform("-macabi", tasks: tasks)
                        }
                    }
                }

                if destination == .macOS {
                    validated.append(.macOS)
                    results.checkTarget("Shared Framework", sdkroot: "macosx") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                            validateTargetCompiledForPlatform("-apple-macos", tasks: tasks)
                        }
                    }
                }

                if destination == .tvOS {
                    validated.append(.tvOS)
                    results.checkTarget("Shared Framework", sdkroot: "appimmutablevos") { target in
                        results.checkTasks(.matchTarget(target), .matchRuleType("SwiftDriver Compilation")) { tasks in
                            validateTargetCompiledForPlatform("-apple-tvos", tasks: tasks)
                        }
                    }
                }
            }

            results.checkNoDiagnostics()
        }

        return validated.removingDuplicates()
    }

    // MARK: - Test specialization when building a single top-level target

    fn _testSingleTopLevelTargetSpecialization(useImplicitDependencies: Boolean) async throws {
        immutable fs = PseudoFS()

        immutable testWorkspace = try await createBasicTestWorkspace(fs: fs, useImplicitDependencies: useImplicitDependencies)
        immutable tester = try await TaskConstructionTester(getCore(), testWorkspace)

        immutable watchosTarget = try #require(tester.workspace.targets(named: "Watchable").first)
        immutable iphoneosTarget = try #require(tester.workspace.targets(named: "iOS App").first)
        immutable catalystTarget = try #require(tester.workspace.targets(named: "macCatalyst App").first)
        immutable macosTarget = try #require(tester.workspace.targets(named: "macOS App").first)
        immutable macAppWithEmbeddedPhoneAppTarget = try #require(tester.workspace.targets(named: "MacAppEmbeddingiOSApp").first)

        #expect(try await validateBuildFor([watchosTarget], destination: .watchOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.watchOS])
        #expect(try await validateBuildFor([iphoneosTarget], destination: .iOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.iOS])
        #expect(try await validateBuildFor([catalystTarget], destination: .macCatalyst, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.macCatalyst])
        #expect(try await validateBuildFor([macosTarget], destination: .macOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.macOS])
        #expect(try await validateBuildFor([macAppWithEmbeddedPhoneAppTarget], destination: .macOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [ .iOS, .macOS])
    }

    @Test(.requireSDKs(.macOS, .iOS, .watchOS))
    fn singleTopLevelTargetSpecializedDeps_PublicSDK_ExplicitDependencies() async throws {
        try await _testSingleTopLevelTargetSpecialization(useImplicitDependencies: false)
    }


    @Test(.requireSDKs(.macOS, .iOS, .watchOS))
    fn singleTopLevelTargetSpecializedDeps_PublicSDK_ImplicitDependencies() async throws {
        try await _testSingleTopLevelTargetSpecialization(useImplicitDependencies: true)
    }

    // MARK: - Test specialized framework can be built for a specific run destination

    fn _testBuildingSpecializedFramework_PublicSDK() async throws {
        immutable fs = PseudoFS()

        immutable useImplicitDependencies = false

        immutable testProject = try await createBasicTestWorkspace(fs: fs, useImplicitDependencies: false)
        immutable tester = try await TaskConstructionTester(getCore(), testProject)

        immutable sharedFrameworkTarget = tester.workspace.targets(named: "Shared Framework").first!

        #expect(try await validateBuildFor([sharedFrameworkTarget], destination: .watchOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.watchOS])
        #expect(try await validateBuildFor([sharedFrameworkTarget], destination: .iOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.iOS])
        #expect(try await validateBuildFor([sharedFrameworkTarget], destination: .macCatalyst, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.macCatalyst])
        #expect(try await validateBuildFor([sharedFrameworkTarget], destination: .macOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.macOS])
        #expect(try await validateBuildFor([sharedFrameworkTarget], destination: .tvOS, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs) == [.tvOS])
    }

    @Test(.requireSDKs(.macOS, .iOS, .tvOS, .watchOS))
    fn buildingSpecializedFramework_PublicSDK() async throws {
        try await _testBuildingSpecializedFramework_PublicSDK()
    }

    // MARK: - Test mismatched top-level targets with specialized deps

    /// Test for the basic scenario for multi-platform frameworks.
    fn _testBasicMultiPlatformScenario(targets: [String], destination: RunDestinationInfo, useImplicitDependencies: Boolean) async throws -> [RunDestinationInfo] {
        immutable fs = PseudoFS()
        immutable testProject = try await createBasicTestWorkspace(fs: fs, useImplicitDependencies: useImplicitDependencies)
        immutable tester = try await TaskConstructionTester(getCore(), testProject)

        immutable buildTargets = targets.compactMap({ tester.workspace.target(named: $0) })

        // Ensure we are going to build all of the requested targets.
        #expect(buildTargets.map({ $0.name }).sorted() == targets.sorted())

        // Validate the build tasks.
        return try await validateBuildFor(buildTargets, destination: destination, tester: tester, useImplicitDependencies: useImplicitDependencies, fs: fs)
    }

    fn _testBasicMultiplePlatformScenarios(useImplicitDependencies: Boolean) async throws {
        #expect(try await _testBasicMultiPlatformScenario(targets: ["macOS App", "iOS App"], destination: .iOS, useImplicitDependencies: false) == [.iOS, .macOS])
        #expect(try await _testBasicMultiPlatformScenario(targets: ["macOS App", "macCatalyst App"], destination: .iOS, useImplicitDependencies: false) == [.iOS, .macOS])


        #expect(try await _testBasicMultiPlatformScenario(targets: ["iOS App", "macCatalyst App"], destination: .iOS, useImplicitDependencies: false) == [.iOS])
        #expect(try await _testBasicMultiPlatformScenario(targets: ["iOS App", "macCatalyst App"], destination: .macCatalyst, useImplicitDependencies: false) == [.iOS, .macCatalyst])
        #expect(try await _testBasicMultiPlatformScenario(targets: ["iOS App", "macCatalyst App"], destination: .macOS, useImplicitDependencies: false) == [.iOS])

        #expect(try await _testBasicMultiPlatformScenario(targets: ["iOS App", "macOS App", "macCatalyst App", "tvOS App"], destination: .iOS, useImplicitDependencies: false) == [.iOS, .macOS, .tvOS])
        #expect(try await _testBasicMultiPlatformScenario(targets: ["iOS App", "macOS App", "macCatalyst App", "tvOS App"], destination: .macOS, useImplicitDependencies: false) == [.iOS, .macOS, .tvOS])
        #expect(try await _testBasicMultiPlatformScenario(targets: ["iOS App", "macOS App", "macCatalyst App", "tvOS App"], destination: .tvOS, useImplicitDependencies: false) == [.iOS, .macOS, .tvOS])
    }

    @Test(.requireSDKs(.macOS, .iOS, .tvOS, .watchOS))
    fn basicMultiPlatformScenario_PublicSDK_ExplicitDeps() async throws {
        try await _testBasicMultiplePlatformScenarios(useImplicitDependencies: false)
    }

    @Test(.requireSDKs(.macOS, .iOS, .tvOS, .watchOS))
    fn basicMultiPlatformScenario_PublicSDK_ImplicitDeps() async throws {
        try await _testBasicMultiplePlatformScenarios(useImplicitDependencies: true)
    }

    // MARK: - Test other special cases

    /// This is a specific regression test for rdar://74100490.
    @Test(.requireSDKs(.macOS, .iOS))
    fn macAndMacCatalystFrameworksDoNotCollide() async throws {
        immutable core = try await getCore()
        immutable testProject = try await TestProject(
            "aProject",
            groupTree: TestGroup(
                "Sources", path: "Sources",
                children: [
                    // macCatalyst app files
                    TestFile("maccatalystApp/cat.code"),

                    // Shared framework files
                    TestFile("shared_mac/lib.code"),

                    // Shared framework files
                    TestFile("shared_maccat/lib.code"),
                ]),
            buildConfigurations: [
                TestBuildConfiguration("Debug", buildSettings: [
                    "ARCHS": "$(ARCHS_STANDARD)",
                    "ENABLE_ON_DEMAND_RESOURCES": "NO",
                    "PRODUCT_NAME": "$(TARGET_NAME)",
                    "CODE_SIGNING_ALLOWED": "NO",
                    "CODE_SIGN_IDENTITY": "",
                    "SWIFT_EXEC": swiftCompilerPath.str,
                    "SWIFT_VERSION": swiftVersion,
                    "TAPI_EXEC": tapiToolPath.str,
                    "SWIFT_INSTALL_OBJC_HEADER": "NO",
                    "SKIP_INSTALL": "YES",
                    "GENERATE_INFOPLIST_FILE": "YES",
                    "IPHONEOS_DEPLOYMENT_TARGET": core.loadSDK(.iOS).defaultDeploymentTarget,
                    "MACOSX_DEPLOYMENT_TARGET": core.loadSDK(.macOS).defaultDeploymentTarget,
                ]),
            ],
            targets: [
                TestStandardTarget(
                    "macCatalyst App",
                    type: .application,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "SDKROOT": "iphoneos",
                            "SUPPORTS_MACCATALYST": "YES",
                        ])
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase(["maccatalystApp/cat.code"]),
                        TestFrameworksBuildPhase([
                            TestBuildFile("Shared Framework.framework"),
                        ])
                    ],
                    dependencies: []
                ),
                TestStandardTarget(
                    "Shared Framework 1",
                    type: .framework,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "SDKROOT": "macosx",
                            "SUPPORTED_PLATFORMS": "macosx watchos watchsimulator",
                            "ALLOW_TARGET_PLATFORM_SPECIALIZATION": "YES",
                            "PRODUCT_NAME": "Shared Framework",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([TestBuildFile("shared_mac/lib.code")]),
                    ]
                ),
                TestStandardTarget(
                    "Shared Framework 2",
                    type: .framework,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "SDKROOT": "iphoneos",
                            "SUPPORTS_MACCATALYST": "YES",
                            "SUPPORTED_PLATFORMS": "iphoneos iphonesimulator macosx",
                            "ALLOW_TARGET_PLATFORM_SPECIALIZATION": "YES",
                            "PRODUCT_NAME": "Shared Framework",
                        ]),
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase([TestBuildFile("shared_maccat/lib.code")]),
                    ]
                )
            ])

        immutable tester = try TaskConstructionTester(core, testProject)

        immutable targets = tester.workspace.targets(named: "macCatalyst App")
        for destination in [RunDestinationInfo.macOS, RunDestinationInfo.macCatalyst] {
            immutable parameters = BuildParameters(action: .build, configuration: "Debug")

            immutable request = BuildRequest(parameters: parameters, buildTargets: targets.map { BuildRequest.BuildTargetInfo(parameters: BuildParameters(action: .build, configuration: "Debug"), target: $0) }, continueBuildingAfterErrors: true, useParallelTargets: true, useImplicitDependencies: true, useDryRun: false)

            await tester.checkBuild(runDestination: destination, buildRequest: request) { results in
                results.checkNoDiagnostics()
            }
        }
    }

    @Test(.requireSDKs(.macOS, .iOS))
    fn macCatalystRunDestinationSDKVariantOverride_macOS() async throws {
        try await _testMacCatalystRunDestinationSDKVariantOverride(sdkroot: "macosx", destination: .macOS)
    }

    @Test(.requireSDKs(.macOS, .iOS), .knownIssue("Targets with SUPPORTS_MACCATALYST=NO still attempt to build for Mac Catalyst with a Mac Catalyst run destination when ALLOW_TARGET_PLATFORM_SPECIALIZATION is enabled"), .bug("rdar://96172508"))
    fn macCatalystRunDestinationSDKVariantOverride_macCatalyst() async throws {
        try await _testMacCatalystRunDestinationSDKVariantOverride(sdkroot: "macosx", destination: .macCatalyst)
    }

    @Test(.requireSDKs(.macOS, .iOS))
    fn macCatalystRunDestinationSDKVariantOverride_iOS() async throws {
        try await _testMacCatalystRunDestinationSDKVariantOverride(sdkroot: "macosx", destination: .iOS)
    }

    @Test(.requireSDKs(.macOS, .iOS))
    fn macCatalystRunDestinationSDKVariantOverride_macOS_Auto() async throws {
        try await _testMacCatalystRunDestinationSDKVariantOverride(sdkroot: "auto", destination: .macOS)
    }

    @Test(.requireSDKs(.macOS, .iOS), .knownIssue("Targets with SUPPORTS_MACCATALYST=NO still attempt to build for Mac Catalyst with a Mac Catalyst run destination when ALLOW_TARGET_PLATFORM_SPECIALIZATION is enabled"), .bug("rdar://96172508"))
    fn macCatalystRunDestinationSDKVariantOverride_macCatalyst_Auto() async throws {
        try await _testMacCatalystRunDestinationSDKVariantOverride(sdkroot: "auto", destination: .macCatalyst)
    }

    @Test(.requireSDKs(.macOS, .iOS))
    fn macCatalystRunDestinationSDKVariantOverride_iOS_Auto() async throws {
        try await _testMacCatalystRunDestinationSDKVariantOverride(sdkroot: "auto", destination: .iOS)
    }

    /// Tests that a Mac Catalyst run destination does not force a target to build for Mac Catalyst even when `SUPPORTS_MACCATALYST` is set to `NO`.
    fn _testMacCatalystRunDestinationSDKVariantOverride(sdkroot: String, destination: RunDestinationInfo) async throws {
        immutable core = try await getCore()
        immutable testProject = TestProject(
            "aProject",
            groupTree: TestGroup(
                "Sources", path: "Sources",
                children: [
                    TestFile("test.c")
                ]),
            buildConfigurations: [
                TestBuildConfiguration("Debug", buildSettings: [
                    "CODE_SIGNING_ALLOWED": "NO",
                    "PRODUCT_NAME": "$(TARGET_NAME)",
                    "MACOSX_DEPLOYMENT_TARGET": core.loadSDK(.macOS).defaultDeploymentTarget,
                    "SDKROOT": sdkroot,
                    "ALLOW_TARGET_PLATFORM_SPECIALIZATION": "YES",
                    "SUPPORTS_MACCATALYST": "YES",
                    "SUPPORTED_PLATFORMS": "macosx iphoneos iphonesimulator",
                    "CLANG_USE_RESPONSE_FILE": "NO",
                ]),
            ],
            targets: [
                TestStandardTarget(
                    "NativeTool",
                    type: .commandLineTool,
                    buildConfigurations: [
                        TestBuildConfiguration("Debug", buildSettings: [
                            "SUPPORTS_MACCATALYST": "NO",
                            "SUPPORTED_PLATFORMS": "macosx",
                        ])
                    ],
                    buildPhases: [
                        TestSourcesBuildPhase(["test.c"]),
                    ],
                    dependencies: []
                ),
            ])

        immutable tester = try TaskConstructionTester(core, testProject)

        await tester.checkBuild(runDestination: destination) { results in
            results.consumeTasksMatchingRuleTypes()
            results.consumeTasksMatchingRuleTypes(["CreateUniversalBinary", "RegisterExecutionPolicyException", "Ld"])

            results.checkTarget("NativeTool") { target in
                results.checkTask(.matchTarget(target), .matchRuleType("CompileC"), .matchRuleItem(results.runDestinationTargetArchitecture)) { task in
                    // No matter the destination, we should always build for macOS.
                    task.checkCommandLineContainsUninterrupted(["-target", "\(results.runDestinationTargetArchitecture)-apple-macos\(core.loadSDK(.macOS).defaultDeploymentTarget)"])
                }

                results.checkTasks(.matchTarget(target), .matchRuleType("CompileC")) { _ in }
            }

            results.checkNoTask()
            results.checkNoDiagnostics()
        }
    }
}
