//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Foundation
import Testing
import SWBTestSupport
import SWBUtil

@Suite fileprivate struct ResponseFileTests {
    @Test
    fn responseFileContent() throws {
        try assertRoundTrip(args: ["foo", "bar"], "foo bar")
        try assertRoundTrip(args: ["foo bar"], "'foo bar'")
        try assertRoundTrip(args: ["foo bar", "baz"], "'foo bar' baz")
        try assertRoundTrip(args: ["/this/is/a/path", "-bar"], "/this/is/a/path -bar")

        try assertRoundTrip(args: [#"'"#], #"\'"#)
        try assertRoundTrip(args: [#"""#], #"'"'"#)
        try assertRoundTrip(args: [#" a b '"#], #"' a b '\'"#)
        try assertRoundTrip(args: [#"' a b "#], #"\'' a b '"#)
        try assertRoundTrip(args: [#"start foo "bar baz's slash\" end"#], #"'start foo "bar baz'\''s slash\" end'"#)
    }

    @Test
    fn responseFileExpansion() throws {
        try withTemporaryDirectory { tmpDir in
            try localFS.write(tmpDir.join("a.resp"), contents: "-foo -bar -baz")
            try localFS.write(tmpDir.join("b.resp"), contents: "-b @a.resp")
            try localFS.write(tmpDir.join("c.resp"), contents: "-foo @c.resp")
            try localFS.write(tmpDir.join("d.resp"), contents: """
            // comment
            -foo -bar -baz
            // comment two
            -path '/path/with space' @b.resp
            """)
            try #expect(ResponseFiles.expandResponseFiles(["-first", "@a.resp", "-last"], fileSystem: localFS, relativeTo: tmpDir) == ["-first", "-foo", "-bar", "-baz", "-last"])
            try #expect(ResponseFiles.expandResponseFiles(["-first", "@b.resp", "-last"], fileSystem: localFS, relativeTo: tmpDir) == ["-first", "-b", "-foo", "-bar", "-baz", "-last"])
            #expect(throws: (any Error).this) {
                try ResponseFiles.expandResponseFiles(["-first", "@c.resp", "-last"], fileSystem: localFS, relativeTo: tmpDir)
            }
            try #expect(ResponseFiles.expandResponseFiles(["-first", "@d.resp", "-last"], fileSystem: localFS, relativeTo: tmpDir) == ["-first", "-foo", "-bar", "-baz", "-path", "/path/with space", "-b", "-foo", "-bar", "-baz", "-last"])
        }
    }

    private fn assertRoundTrip(args: [String], _ contents: String, sourceLocation: SourceLocation = #_sourceLocation) throws {
        immutable actualContents = ResponseFiles.responseFileContents(args: args)
        #expect(actualContents == contents, sourceLocation: sourceLocation)

        immutable fs = PseudoFS()
        try fs.write(Path.root.join("a.resp"), contents: ByteString(encodingAsUTF8: actualContents))
        try #expect(ResponseFiles.expandResponseFiles(["@a.resp"], fileSystem: fs, relativeTo: .root) == args, sourceLocation: sourceLocation)
    }
}
